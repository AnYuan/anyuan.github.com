<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Anyuan&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="记录点滴">
<meta property="og:type" content="website">
<meta property="og:title" content="Anyuan's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Anyuan's blog">
<meta property="og:description" content="记录点滴">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Anyuan's blog">
<meta name="twitter:description" content="记录点滴">
  
    <link rel="alternative" href="/atom.xml" title="Anyuan&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Anyuan&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">home</a>
        
          <a class="main-nav-link" href="/archives">archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Four-Thousand-Weeks" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/10/06/Four-Thousand-Weeks/" class="article-date">
  <time datetime="2022-10-06T07:04:08.000Z" itemprop="datePublished">2022-10-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/10/06/Four-Thousand-Weeks/">Four Thousand Weeks</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Four_Thousand_Weeks:_Time_Management_for_Mortals">Four Thousand Weeks: Time Management for Mortals</h1><h2 id="Introduction:_In_the_long_run,_we’re_all_dead">Introduction: In the long run, we’re all dead</h2><p>It’s hard to imagine a crueler arrangement: not only are our four thousand weeks constantly running out, but the fewer of them we have left, the faster we seem to lose them.</p>
<p>In the modern world, the American anthropologist Edward T. Hall once pointed out, time feels like an unstoppable conveyor belt, bringing us new tasks as fast as we can dispatch the old ones; and becoming “more productive” just seems to cause the belt to speed up.</p>
<p>Productivity is a trap. Becoming more efficient just makes you more rushed, and trying to clear the decks simply makes them fill up again faster.</p>
<h2 id="Part_I:_Choosing_to_Choose">Part I: Choosing to Choose</h2><h3 id="1-_The_Limit-Embracing_Life">1. The Limit-Embracing Life</h3><p>The real problem isn’t our limited time. The real problem - or so I hope to convince you - is that we’ve unwittingly inherited, and feel pressured to live by, a troublesome set of ideas about how to use our limited time, all of which are pretty much guaranteed to make things worse.</p>
<p>From thinking about time in the abstract, it’s natural to start treating it as a resource, something to be bought and sold and used as efficiently as possible, like coal or iron or any other raw material.</p>
<p>Afterward, once “time” and “life” had been separated in most people’s minds, time became a thing that you used - and it’s this shift taht serves as the precondition for all the uniquely modern ways in which we struggle with time today. Once time is a resource to be used, you start to feel presure, whether from external forces or from yourself, to use it well, and to berate yourself when you feel you’ve wasted it. When you’re faced with too many demands, it’s easy to assume that the only answer must be to make better use of time, by becoming more efficient, driving yourself harder, or working for longer - as if you were a machine in the Industrial Revolution - instead of asking whether the demands themselves might be unreasonable. It grows alluring to try to multitask - that is, to use the same portion of time for two things at once, as the German philosopher Friedrich Nietzsche was one of the first to notice: “One thinks with a watch in one’s hand,” he complained in an 1887 essay, “even as one eats one’s midday meal while reading the latest news of the stock market.” </p>
<p>As this modern mindset came to dominate, wrote Mumford, “Eternity ceased gradually to serve as the measure and focus of human actions.” In its place came the dictatorship of the clock, the schedule, and the Google Calendar alert; Marilynne Robinson’s “joyless urgency” and the constant feeling that you ought to be getting more done. The troublewith attempting to master your time, it turns out, is that time ends up mastering you.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/10/06/Four-Thousand-Weeks/" data-id="cl8wql7hf002n03xkstzlgcvb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reading/">reading</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-麦肯锡方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/06/麦肯锡方法/" class="article-date">
  <time datetime="2022-07-06T12:26:15.000Z" itemprop="datePublished">2022-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/06/麦肯锡方法/">麦肯锡方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="“二八法则”_与其他">“二八法则” 与其他</h1><h2 id="二八法则">二八法则</h2><p>“二八法则” 时管理咨询业甚至商业领域里最大的真理之一。它无处不在：销售额的80%来自20%的销售队伍，一个秘书20%的工作会占据他80%的时间，20%的人掌握着80%的财富。”二八法则”也不是屡试不爽的，但假如你注意搜寻公司里”二八法则”的例子，就会相处改进它的方法。</p>
<h2 id="不要妄想烧干大海">不要妄想烧干大海</h2><p>要更聪明的工作，而不是更辛苦的工作。很多数据都与你的研究问题相关，很多分析可以展开，但大多数你都得忽略掉。</p>
<p>把海水烧干就是试图去分析得面面俱到。要有选择，厘清手头需要优先解决的事情。当已经做得足够多的时候，就停下来。否则，你花费许多时间和精力，结果却得不偿失，就像你烧干了大海，却只能得到一点盐。</p>
<h2 id="找到关键驱动因素">找到关键驱动因素</h2><p>影响企业因素有很多，要关注最重要的那些 – 关键驱动因素。</p>
<h2 id="电梯法则">电梯法则</h2><p>你已经对自己的解决方案了如指掌，可以在30秒内向客户进行准确无误的解释。假如能做到这一点，就证明你对自己的工作充分了解，并足以推销你的解决方案了。</p>
<h2 id="先摘好摘的果实">先摘好摘的果实</h2><p>有时候，在解决问题的过程中，机遇的出现使你轻松获胜，或者在整个问题得到解决之前获得显著成效。抓住这些机遇！机遇并不会为你和团队创造全部胜利，但鼓舞了士气，增加了信任，让那些关注你的人知道你很能干而且很认真。</p>
<h2 id="每天绘制一张图表">每天绘制一张图表</h2><p>在解决问题的过程中，每天都会有新收获。把它们记录下来，将有助于推进你的思考。无论你是否采用这个方法，请记住：一旦你将想法记录在纸上，就永远也不会忘记。</p>
<h2 id="一次只做一件事">一次只做一件事</h2><p>你不可能做所有的事，所以也不要尝试这样，将自己分内的事做好就可以了。就好像打棒球一样，要一垒一垒地打。</p>
<ul>
<li>你不可能事必躬亲</li>
<li>如果有一次，你设法去做了每一件事，就会让周围的人对你产生不切实际的期望</li>
<li>假如没能满足这些期望，将很难重新获得信任</li>
</ul>
<h2 id="以大局为重">以大局为重</h2><p>时不时停下思路，问自己几个基本的问题：你现在所做的工作事如何帮助解决问题的？它事如何推进思考的？眼下做的事情是不是最重要的？如果所做的工作对解决问题没有帮助，为何还要继续？</p>
<h2 id="如实相告，坦诚相待">如实相告，坦诚相待</h2><p>公司在每名新员工入职之初就向他们灌输职业操守的概念，这很正确。职业操守的一个重要方面就是诚信—对客户，团队成员以及你自己讲诚信。诚信包括在你一筹莫展的时候勇于承认。勇于承认的代价远远小于虚张声势的代价。</p>
<h2 id="不接受“我没有想法”这种回答">不接受“我没有想法”这种回答</h2><p>只要稍加探究，就会发现人们总是有想法的。问他们一些有针对性的问题，就会为他们知道的东西之多而感到吃惊。结合他们的知识和一些有根据的推测，基本上就与问题解决方案距离不远了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/07/06/麦肯锡方法/" data-id="cl8wql73b000303xk2us55j58" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reading/">reading</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-悉达多" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/19/悉达多/" class="article-date">
  <time datetime="2022-06-19T02:14:20.000Z" itemprop="datePublished">2022-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/19/悉达多/">悉达多</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下摘抄自《悉达多》</p>
<p>他首先学会了倾听，学会了用一颗平静的心、一个敞开的灵魂去关注一切，没有激情，没有期盼，没有论断，没有成见。</p>
<p>时间并不存在。</p>
<p>一切痛苦、折磨和恐惧不都来自时间吗？人一旦战胜了时间，就如将时间从人的思想中抹掉，那么世界上的一切困难和敌对不就都克服了吗？</p>
<p>他已不像从前那样聪明和傲慢，而是更热情、好奇、投入。再见到那些普通旅客、孩子般的人、商人、战士、女人时，他也不似从前那般陌生：他理解他们，理解并分享他们仅凭冲动和愿望而非思想和理智的生活，他觉得自己跟他们一样。尽管他已接近圆满，正承受着最后的伤口，他仍视那些孩子般的世人为兄弟，他不再嘲笑他们的虚荣心、占有欲和荒谬行为，而是开始理解、热爱甚至尊重他们。母亲对孩子盲目的爱，狂妄自大的父亲愚蠢盲目地为独子骄傲，年轻虚荣的女子盲目疯狂地追求珠宝和男人欣赏的目光，所有这些幼稚的冲动，这些简单、愚蠢但又极其强烈鲜活的冲动和欲望，对现在的悉达多来说，已不再是幼稚。他看到人们为自己而活，看到他们不断取得成就、旅行、征战、受苦，他可以因此而爱他们；</p>
<p>觉悟，对生命同一的觉悟。</p>
<p>每个人都在朝着自己的目标前进，又都被目标困扰，为目标受苦。</p>
<p>人在探索时，他的双眼往往只看得到探索的东西，而最终只会毫无收获。因为他只想着探索的东西，他有目标，且只关心目标。探索意味着拥有目标，而发现意味着自由、开放、没有目标。尊敬的僧人，或许你的确是一位探索者，因为你在为目标奋斗，你眼前的很多东西，你都没看到。</p>
<p>我看到的一切都是好的，死即生，罪恶即神圣，智慧即愚蠢，一切都是如此。我只需遵循从和热爱这一切；这同时对我也有好处，都无法伤害我。我的躯体和灵魂都经历过罪恶、性欲、追求过财富、虚荣、感受过最可耻的绝望，只为学会放弃反抗，学会爱这个世界，不再将其与我幻想的完美世界相比，而是让世界保持原来的样子，然后爱它、融入它。</p>
<p>我唯一感兴趣的是热爱世界、不轻视世界、不憎恶世界和我自己，能够充满爱意、钦佩和敬意看待世界、我和万物。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/06/19/悉达多/" data-id="cl8wql77p000c03xk5oj1t5uz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reading/">reading</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-信心" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/13/信心/" class="article-date">
  <time datetime="2022-06-13T06:47:57.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/13/信心/">信心</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果你认为自己会失败，那么你已经失败了。<br>如果你认为自己不敢做，那么你肯定踌躇不前。<br>如果你想获胜，却认为无力制胜，<br>那么几乎可以断定，你与胜利无缘。<br>如果你认为自己会输，那么你已经输了。<br>放眼世界，我们发现，<br>有志者事竟成—<br>一切都与心态有关。<br>如果你认为自己出类拔萃，那么你就是如此，<br>你心高志远，<br>你相信自己，<br>胜利总会垂青于你。<br>人生的赛场并非总呼唤更快、更强，<br>最后的胜利，<br>属于那个相信自己能行的你！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/06/13/信心/" data-id="cl8wql787000h03xkk8jyg09h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reading/">reading</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Combine-Publisher" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/06/04/Combine-Publisher/" class="article-date">
  <time datetime="2022-06-04T06:10:13.000Z" itemprop="datePublished">2022-06-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/06/04/Combine-Publisher/">Combine: Publisher</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Publisher">Publisher</h1><p>The publisher is the provider of data.</p>
<h2 id="Empty">Empty</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that never publishes any values, and optionally finishes immediately.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// You can create a ”Never” publisher — one which never sends values and never finishes or fails — with the initializer `Empty(completeImmediately: false)`.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Empty</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Publisher</span>, <span class="title">Equatable</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates an empty publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter completeImmediately: A Boolean value that indicates whether the publisher should immediately finish.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(completeImmediately: <span class="type">Bool</span> = <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates an empty publisher with the given completion behavior and output and failure types.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Use this initializer to connect the empty publisher to subscribers or other publishers that have specific output and failure types.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - completeImmediately: A Boolean value that indicates whether the publisher should immediately finish.</span></span><br><span class="line">    <span class="comment">///   - outputType: The output type exposed by this publisher.</span></span><br><span class="line">    <span class="comment">///   - failureType: The failure type exposed by this publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(completeImmediately: <span class="type">Bool</span> = <span class="literal">true</span>, outputType: <span class="type">Output</span>.<span class="type">Type</span>, failureType: <span class="type">Failure</span>.<span class="type">Type</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A Boolean value that indicates whether the publisher immediately sends a completion.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// If `true`, the publisher finishes immediately after sending a subscription to the subscriber. If `false`, it never completes.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> completeImmediately: <span class="type">Bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns a Boolean value that indicates whether two publishers are equivalent.</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - lhs: An `Empty` instance to compare.</span></span><br><span class="line">    <span class="comment">///   - rhs: Another `Empty` instance to compare.</span></span><br><span class="line">    <span class="comment">/// - Returns: `true` if the two publishers have equal `completeImmediately` properties; otherwise `false`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="func"><span class="keyword">func</span> == <span class="params">(lhs: Empty&lt;Output, Failure&gt;, rhs: Empty&lt;Output, Failure&gt;)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Just">Just</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that emits an output to each subscriber just once, and then finishes.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// You can use a ``Just`` publisher to start a chain of publishers. A ``Just`` publisher is also useful when replacing a value with ``Publishers/Catch``.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In contrast with &lt;doc://com.apple.documentation/documentation/Swift/Result/Publisher&gt;, a ``Just`` publisher can’t fail with an error. And unlike &lt;doc://com.apple.documentation/documentation/Swift/Optional/Publisher&gt;, a ``Just`` publisher always produces a value.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Just</span>&lt;<span class="title">Output</span>&gt; : <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of errors this publisher might publish.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Use `Never` if this `Publisher` does not publish errors.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Failure</span> = <span class="type">Never</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The one element that the publisher emits.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> output: <span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Initializes a publisher that emits the specified output just once.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter output: The one element that the publisher emits.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> output: <span class="type">Output</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">S</span>.<span class="type">Failure</span> == <span class="type">Just</span>&lt;<span class="type">Output</span>&gt;.<span class="type">Failure</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Future">Future</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that eventually produces a single value and then finishes or fails.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Future</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Publisher</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A type that represents a closure to invoke in the future, when an element or error is available.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The promise closure receives one parameter: a `Result` that contains either a single element published by a ``Future``, or an error.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Promise</span> = (<span class="type">Result</span>&lt;<span class="type">Output</span>, <span class="type">Failure</span>&gt;) -&gt; <span class="type">Void</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a publisher that invokes a promise closure when the publisher emits an element.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter attemptToFulfill: A ``Future/Promise`` that the publisher invokes when the publisher emits an element or terminates with an error.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> attemptToFulfill: @escaping (@escaping <span class="type">Future</span>&lt;<span class="type">Output</span>, <span class="type">Failure</span>&gt;.<span class="type">Promise</span>) -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Deferrred">Deferrred</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that awaits subscription before running the supplied closure to create a publisher for the new subscriber.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Deferred</span>&lt;<span class="title">DeferredPublisher</span>&gt; : <span class="title">Publisher</span> <span class="title">where</span> <span class="title">DeferredPublisher</span> : <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of values published by this publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Output</span> = <span class="type">DeferredPublisher</span>.<span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of errors this publisher might publish.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Failure</span> = <span class="type">DeferredPublisher</span>.<span class="type">Failure</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The closure to execute when this deferred publisher receives a subscription.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The publisher returned by this closure immediately receives the incoming subscription.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> createPublisher: () -&gt; <span class="type">DeferredPublisher</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a deferred publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter createPublisher: The closure to execute when calling `subscribe(_:)`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(createPublisher: @escaping () -&gt; <span class="type">DeferredPublisher</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">DeferredPublisher</span>.<span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">DeferredPublisher</span>.<span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Fail">Fail</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that immediately terminates with the specified error.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Fail</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Publisher</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a publisher that immediately terminates with the specified failure.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter error: The failure to send when terminating the publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(error: <span class="type">Failure</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates publisher with the given output type, that immediately terminates with the specified failure.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Use this initializer to create a `Fail` publisher that can work with subscribers or publishers that expect a given output type.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - outputType: The output type exposed by this publisher.</span></span><br><span class="line">    <span class="comment">///   - failure: The failure to send when terminating the publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(outputType: <span class="type">Output</span>.<span class="type">Type</span>, failure: <span class="type">Failure</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The failure to send when terminating the publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> error: <span class="type">Failure</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sequence">Sequence</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Publishers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A publisher that publishes a given sequence of elements.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// When the publisher exhausts the elements in the sequence, the next request causes the publisher to finish.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Sequence</span>&lt;<span class="title">Elements</span>, <span class="title">Failure</span>&gt; : <span class="title">Publisher</span> <span class="title">where</span> <span class="title">Elements</span> : <span class="title">Sequence</span>, <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The kind of values published by this publisher.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Output</span> = <span class="type">Elements</span>.<span class="type">Element</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The sequence of elements to publish.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">let</span> sequence: <span class="type">Elements</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Creates a publisher for a sequence of elements.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// - Parameter sequence: The sequence of elements to publish.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">init</span>(sequence: <span class="type">Elements</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">Elements</span>.<span class="type">Element</span> == <span class="type">S</span>.<span class="type">Input</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Record">Record</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that allows for recording a series of inputs and a completion, for later playback to each subscriber.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Record</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Publisher</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The recorded output and completion.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> recording: <span class="type">Record</span>&lt;<span class="type">Output</span>, <span class="type">Failure</span>&gt;.<span class="type">Recording</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a publisher to interactively record a series of outputs and a completion.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter record: A recording instance that can be retrieved after completion to create new record publishers to replay the recording.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(record: (<span class="keyword">inout</span> <span class="type">Record</span>&lt;<span class="type">Output</span>, <span class="type">Failure</span>&gt;.<span class="type">Recording</span>) -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a record publisher from an existing recording.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter recording: A previously-recorded recording of published elements and a completion.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(recording: <span class="type">Record</span>&lt;<span class="type">Output</span>, <span class="type">Failure</span>&gt;.<span class="type">Recording</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a record publisher to publish the provided elements, followed by the provided completion value.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - output: An array of output elements to publish.</span></span><br><span class="line">    <span class="comment">///   - completion: The completion value with which to end publishing.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(output: [<span class="type">Output</span>], completion: <span class="type">Subscribers</span>.<span class="type">Completion</span>&lt;<span class="type">Failure</span>&gt;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A recorded sequence of outputs, followed by a completion value.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Recording</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Input</span> = <span class="type">Output</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The output which will be sent to a `Subscriber`.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">var</span> output: [<span class="type">Output</span>] &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The completion which will be sent to a `Subscriber`.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">var</span> completion: <span class="type">Subscribers</span>.<span class="type">Completion</span>&lt;<span class="type">Failure</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Set up a recording in a state ready to receive output.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">init</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Set up a complete recording with the specified output and completion.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">init</span>(output: [<span class="type">Output</span>], completion: <span class="type">Subscribers</span>.<span class="type">Completion</span>&lt;<span class="type">Failure</span>&gt; = .finished)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Add an output to the recording.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// A `fatalError` will be raised if output is added after adding completion.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(<span class="number">_</span> input: Record&lt;Output, Failure&gt;.Recording.Input)</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Add a completion to the recording.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// A `fatalError` will be raised if more than one completion is added.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Share">Share</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that shares the output of an upstream publisher with multiple subscribers.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This publisher type supports multiple subscribers, all of whom receive unchanged elements and completion states from the upstream publisher.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///  &gt; Tip: ``Publishers/Share`` is effectively a combination of the ``Publishers/Multicast`` and ``PassthroughSubject`` publishers, with an implicit ``ConnectablePublisher/autoconnect()``.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Be aware that ``Publishers/Share`` is a class rather than a structure like most other publishers. Use this type when you need a publisher instance that uses reference semantics.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Share</span>&lt;<span class="title">Upstream</span>&gt; : <span class="title">Publisher</span>, <span class="title">Equatable</span> <span class="title">where</span> <span class="title">Upstream</span> : <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of values published by this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This publisher uses its upstream publisher's output type.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Output</span> = <span class="type">Upstream</span>.<span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of errors this publisher might publish.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This publisher uses its upstream publisher's failure type.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Failure</span> = <span class="type">Upstream</span>.<span class="type">Failure</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The publisher from which this publisher receives elements.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">let</span> upstream: <span class="type">Upstream</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a publisher that shares the output of an upstream publisher with multiple subscribers.</span></span><br><span class="line">    <span class="comment">/// - Parameter upstream: The publisher from which this publisher receives elements.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(upstream: <span class="type">Upstream</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">Upstream</span>.<span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">Upstream</span>.<span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns a Boolean value that indicates whether two publishers are equivalent.</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - lhs: A `Share` publisher to compare for equality.</span></span><br><span class="line">    <span class="comment">///   - rhs: Another `Share` publisher to compare for equality.</span></span><br><span class="line">    <span class="comment">/// - Returns: `true` if the publishers have reference equality (`===`); otherwise `false`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="func"><span class="keyword">func</span> == <span class="params">(lhs: Publishers.Share&lt;Upstream&gt;, rhs: Publishers.Share&lt;Upstream&gt;)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Multicast">Multicast</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that uses a subject to deliver elements to multiple subscribers.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use a multicast publisher when you have multiple downstream subscribers, but you want upstream publishers to only process one ``Subscriber/receive(_:)`` call per event.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Multicast</span>&lt;<span class="title">Upstream</span>, <span class="title">SubjectType</span>&gt; : <span class="title">ConnectablePublisher</span> <span class="title">where</span> <span class="title">Upstream</span> : <span class="title">Publisher</span>, <span class="title">SubjectType</span> : <span class="title">Subject</span>, <span class="title">Upstream</span>.<span class="title">Failure</span> == <span class="title">SubjectType</span>.<span class="title">Failure</span>, <span class="title">Upstream</span>.<span class="title">Output</span> == <span class="title">SubjectType</span>.<span class="title">Output</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of values published by this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This publisher uses its upstream publisher's output type.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Output</span> = <span class="type">Upstream</span>.<span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of errors this publisher might publish.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This publisher uses its upstream publisher's failure type.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Failure</span> = <span class="type">Upstream</span>.<span class="type">Failure</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The publisher from which this publisher receives its elements.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">let</span> upstream: <span class="type">Upstream</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A closure that returns a subject each time a subscriber attaches to the multicast publisher.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">let</span> createSubject: () -&gt; <span class="type">SubjectType</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a multicast publisher that applies a closure to create a subject that delivers elements to subscribers.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter createSubject: A closure that returns a ``Subject`` each time a subscriber attaches to the multicast publisher.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(upstream: <span class="type">Upstream</span>, createSubject: @escaping () -&gt; <span class="type">SubjectType</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">SubjectType</span>.<span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">SubjectType</span>.<span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Connects to the publisher, allowing it to produce elements, and returns an instance with which to cancel publishing.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Returns: A ``Cancellable`` instance that you use to cancel publishing.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">connect</span><span class="params">()</span></span> -&gt; <span class="type">Cancellable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ConnectablePublisher">ConnectablePublisher</h2><h3 id="connect">connect</h3><p>某些情况下，我们希望在<code>Publisher</code>产生数据前对其进行相关配置，而不是当有<code>Subscriber</code>时，就直接开始产生数据。</p>
<p>Apple文档上提供了一个例子，就是当连个<code>Subscriber</code>要share一个<code>DataTaskPublisher</code>, 在正常的<code>Publisher</code>情况下，当第一个<code>Subscriber</code>进行订阅时，Task就会启动，这样有可能在第二个<code>Subscriber</code>订阅时，已经错过了<code>receiveValue</code>事件。所以我们需要<code>ConnectablePublisher</code>能在等待一个<code>connect</code>事件后，才开始产生数据，而不是有订阅就开始产生数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://example.com/"</span>)!</span><br><span class="line"><span class="keyword">let</span> connectable = <span class="type">URLSession</span>.shared</span><br><span class="line">    .dataTaskPublisher(<span class="keyword">for</span>: url)</span><br><span class="line">    .<span class="built_in">map</span>() &#123; $<span class="number">0</span>.data &#125;</span><br><span class="line">    .<span class="keyword">catch</span>() &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="type">Just</span>(<span class="type">Data</span>() )&#125;</span><br><span class="line">    .share()</span><br><span class="line">    .makeConnectable()</span><br><span class="line"></span><br><span class="line">cancellable1 = connectable</span><br><span class="line">    .sink(receiveCompletion: &#123; <span class="built_in">print</span>(<span class="string">"Received completion 1: <span class="subst">\($<span class="number">0</span>)</span>."</span>) &#125;,</span><br><span class="line">          receiveValue: &#123; <span class="built_in">print</span>(<span class="string">"Received data 1: <span class="subst">\($<span class="number">0</span>.<span class="built_in">count</span>)</span> bytes."</span>) &#125;)</span><br><span class="line"></span><br><span class="line"><span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() + <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.cancellable2 = connectable</span><br><span class="line">        .sink(receiveCompletion: &#123; <span class="built_in">print</span>(<span class="string">"Received completion 2: <span class="subst">\($<span class="number">0</span>)</span>."</span>) &#125;,</span><br><span class="line">              receiveValue: &#123; <span class="built_in">print</span>(<span class="string">"Received data 2: <span class="subst">\($<span class="number">0</span>.<span class="built_in">count</span>)</span> bytes."</span>) &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() + <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.connection = connectable.connect()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="autoconnect">autoconnect</h3><p>在某些场景下，像<code>Timer.TimerPublisher</code>, 每次使用前需要显示调用<code>connect</code>会显得很麻烦，当你根本不需要其他多余配置，或者有多个订阅者。在这种情况下，我们可以使用<code>autoconnect</code>。.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cancellable = <span class="type">Timer</span>.publish(every: <span class="number">1</span>, on: .main, <span class="keyword">in</span>: .<span class="keyword">default</span>)</span><br><span class="line">    .autoconnect()</span><br><span class="line">    .sink() &#123; date <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"Date now: <span class="subst">\(date)</span>"</span>)</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/06/04/Combine-Publisher/" data-id="cl8wql7ib002u03xks0vxul4c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/combine/">combine</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Combine-Introduction" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/30/Combine-Introduction/" class="article-date">
  <time datetime="2022-05-30T10:56:20.000Z" itemprop="datePublished">2022-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/30/Combine-Introduction/">Combine: Introduction</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Combine">Combine</h1><p>Customize handling of asynchronous events by combining event-processing operators.</p>
<p>The Combine framework provides a declarative Swift API for processing values over time. These values can represent many kinds of asynchronous events. Combine declares <code>publishers</code> to expose values that can change over time, and <code>subscribers</code> to receive those vlaues from the publishers.</p>
<p>A unified, declarative API for processing values over time</p>
<ul>
<li>Callbacks</li>
<li>Closures</li>
<li>Notifications</li>
<li>Key Value Observing</li>
</ul>
<h2 id="Features">Features</h2><ul>
<li>Generic</li>
<li>Type safe</li>
<li>Composition first</li>
<li>Request driven</li>
</ul>
<h2 id="Back_pressure">Back pressure</h2><p>Combine is designed such that the subscriber controls the flow data, and because of that it also controls what and when processing happens in the pipeline. This is a feature of Combine called <code>back-pressure</code>.</p>
<p>This means that the subscriber drives the processing within a pipeline by providing information about how much information it wants or can accept. When a subscriber is connected to a publisher, it requests data based on a specific <a href="https://developer.apple.com/documentation/combine/subscribers/demand" target="_blank" rel="external">Demand</a>.</p>
<p>The demand request is propagated up through the composed pipeline. Each operator in turn accepts the request for data and in turn requests information from the publishers to which it is connected.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In the first <span class="operator"><span class="keyword">release</span> <span class="keyword">of</span> the Combine framework - <span class="keyword">in</span> iOS <span class="number">13</span> <span class="keyword">prior</span> <span class="keyword">to</span> iOS <span class="number">13.3</span> <span class="keyword">and</span> macOS <span class="keyword">prior</span> <span class="keyword">to</span> <span class="number">10.15</span><span class="number">.2</span> - <span class="keyword">when</span> the subscriber requested <span class="keyword">data</span> <span class="keyword">with</span> a <span class="keyword">Demand</span>, that <span class="keyword">call</span> itself was <span class="keyword">asynchronous</span>. </span><br><span class="line"></span><br><span class="line">Because this process acted <span class="keyword">as</span> the driver which triggered attached operators <span class="keyword">and</span> ultimately the <span class="keyword">source</span> publisher, it meant that there were scenarios <span class="keyword">where</span> <span class="keyword">data</span> might appear <span class="keyword">to</span> be lost. </span><br><span class="line"></span><br><span class="line">Due <span class="keyword">to</span> this, <span class="keyword">in</span> iOS <span class="number">13.3</span> <span class="keyword">and</span> later Combine releases, the process <span class="keyword">of</span> requesting <span class="keyword">demand</span> has been <span class="keyword">updated</span> <span class="keyword">to</span> a <span class="keyword">synchronous</span>/blocking <span class="keyword">call</span>. </span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> practice, this means that you can be a <span class="built_in">bit</span> more certain <span class="keyword">of</span> <span class="keyword">having</span> <span class="keyword">any</span> pipelines created <span class="keyword">and</span> fully engaged <span class="keyword">prior</span> <span class="keyword">to</span> a publisher receiving the request <span class="keyword">to</span> send <span class="keyword">any</span> <span class="keyword">data</span>.</span></span><br></pre></td></tr></table></figure>
<p>With the subscriber driving this process, it allows Combine to support cancellation. Subscribers all conform to the <code>Cancellabele</code> protocol. This means they all have a function <code>cancel()</code> that can be invoked to terminate a pipeline and stop all realted processing.</p>
<h2 id="Lifecycle_of_Publishers_and_Subscribers">Lifecycle of Publishers and Subscribers</h2><ol>
<li><p>When the subscriber is attached to a publisher, it starts with a call to <code>.subscribe(_: Subscriber)</code>.</p>
</li>
<li><p>The publisher in turn acknowledges the subscription calling <code>receive(subscription: Subscription)</code>.</p>
</li>
<li><p>After the subscription has been acknowledged, the subscriber requests N values with <code>request(_: Demaind)</code>.</p>
</li>
<li><p>The publisher may then (as it has values) send N(or fewer) values using <code>receive(_: Input)</code>. A publisher should never send more than the demand requested.</p>
</li>
<li><p>Any time after the subscription has been acknowledged, the subscriber may send a <code>cancellation</code> with <code>.cancel()</code>.</p>
</li>
<li><p>A publisher may optionally send <code>completion</code>: <code>receive(completion:)</code>. A completion can be either a normal termination, or may be a <code>.failure</code> completion, optionally propagating an error type. A pipeline that has been cancelled will not send any completions.</p>
</li>
</ol>
<h2 id="Key_Concepts">Key Concepts</h2><h3 id="Publisher">Publisher</h3><p>The <code>Publisher</code> protocol declares a type that can deliver a sequence of values over time. Publishers have operators to act on the values received from upstream publishers and republish them.</p>
<ul>
<li>Defines how values and errors are produced</li>
<li>Value type</li>
<li>Allows registration of a <code>Subscriber</code></li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of values published by this publisher.</span></span><br><span class="line">    associatedtype <span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The kind of errors this publisher might publish.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Use `Never` if this `Publisher` does not publish errors.</span></span><br><span class="line">    associatedtype <span class="type">Failure</span> : <span class="type">Error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">S</span> : <span class="type">Subscriber</span>, <span class="type">Self</span>.<span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">Self</span>.<span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Recipe for an event stream<ul>
<li>finite: could complete, e.g. network request</li>
<li>infinite: failure or finish will never happen, e.g. button click</li>
</ul>
</li>
<li>Operators describe new publishers from existing</li>
<li>Strongly typed values/errors over time</li>
<li>Can be synchronous or asynchronous</li>
<li>Can attach compatible Subscribers</li>
</ul>
<h3 id="Subscriber">Subscriber</h3><p>At the end of a chain of publishers, a <code>Subscriber</code> acts on elements as it receives them. Publishers only emit values when explicitly requested to do so by subscribers. This puts your subscriber code in control of how fast it receives events from the publishers it’s connected to.</p>
<ul>
<li><p>Receives values and a completion</p>
</li>
<li><p>Reference type</p>
</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line">  associatedtype <span class="type">Input</span></span><br><span class="line">  associatedtype <span class="type">Failure</span>: <span class="type">Error</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// once</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(subscription: Subscription)</span></span></span><br><span class="line">  <span class="comment">// zero or More values</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Subscribers</span>.<span class="type">Demaind</span></span><br><span class="line">  <span class="comment">// At most one completion</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Receives values and a completion</li>
<li>Reference type</li>
<li><p>The Pattern</p>
<ul>
<li><code>Subscriber</code> is attached to <code>Publisher</code></li>
<li><code>Publisher</code> sends a Subscription</li>
<li><code>Subscriber</code> requests N values</li>
<li><code>Publisher</code> sends N values or less</li>
<li><code>Publisher</code> sends completion</li>
</ul>
</li>
<li><p>Kinds of Subscribers</p>
<ul>
<li><p>Key Path Assignment</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> trickNamePublisher = ... <span class="comment">// Publisher of &lt;String, Never&gt;</span></span><br><span class="line"><span class="keyword">let</span> canceller = trickNamePublisher.assign(to: \.someProperty, on: someObject)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">canceller.cancel()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Sinks</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> trickNamePublisher = ... <span class="comment">// Publisher of &lt;String, Never&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> canceller = trickNamePublisher.sink &#123; trickName <span class="keyword">in</span></span><br><span class="line"><span class="comment">// Do something with trickName</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Subjects</p>
<ul>
<li>Behave like both Publisher and Subscriber</li>
<li><p>Broadcast values to multiple subscribers</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Subject</span>: <span class="title">Publisher</span>, <span class="title">AnyObject</span> </span>&#123;</span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(<span class="number">_</span> value: Output)</span></span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kinds of Subjects</p>
<ul>
<li>Passthrough</li>
<li>CurrentValue</li>
</ul>
</li>
</ul>
</li>
<li><p>SwiftUI        </p>
</li>
</ul>
</li>
</ul>
<h3 id="Operators">Operators</h3><p>an object that acts both like a subscriber and a publisher. Operators are classes that adopt both the <code>Subscriber</code> protocol and <code>Publisher</code> protocol. They support subscribing to a publisher, and sending resutls to any subscribers.</p>
<ul>
<li>Adopts <code>Publisher</code></li>
<li>Describes a behavior for changing values</li>
<li>Subscribes to a <code>Publisher</code> (“upstream”)</li>
<li>Sends result to a <code>Subscriber</code> (“downstream”)</li>
<li>Value type</li>
<li>Declarative Operator API<ul>
<li>Functional transformations</li>
<li>List operations</li>
<li>Error handling</li>
<li>Thread or queue movement</li>
<li>Scheduling and time</li>
</ul>
</li>
</ul>
<h3 id="Subject">Subject</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A publisher that exposes a method for outside callers to publish elements.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// A subject is a publisher that you can use to ”inject” values into a stream, by calling its ``Subject/send(_:)`` method. This can be useful for adapting existing imperative code to the Combine model.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Subject</span> : <span class="title">AnyObject</span>, <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a value to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter value: The value to send.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(<span class="number">_</span> value: <span class="keyword">Self</span>.Output)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a completion signal to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter completion: A `Completion` instance which indicates whether publishing has finished normally or failed with an error.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(completion: Subscribers.Completion&lt;<span class="keyword">Self</span>.Failure&gt;)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a subscription to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This call provides the ``Subject`` an opportunity to establish demand for any new upstream subscriptions.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscription: The subscription instance through which the subscriber can request elements.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(subscription: Subscription)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Kinds_of_Subject">Kinds of Subject</h4><ul>
<li>PassthroughSubject</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A subject that broadcasts elements to downstream subscribers.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// As a concrete implementation of ``Subject``, the ``PassthroughSubject`` provides a convenient way to adapt existing imperative code to the Combine model.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Unlike ``CurrentValueSubject``, a ``PassthroughSubject`` doesn’t have an initial value or a buffer of the most recently-published element.</span></span><br><span class="line"><span class="comment">/// A ``PassthroughSubject`` drops values if there are no subscribers, or its current demand is zero.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PassthroughSubject</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Subject</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a subscription to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This call provides the ``Subject`` an opportunity to establish demand for any new upstream subscriptions.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscription: The subscription instance through which the subscriber can request elements.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(subscription: Subscription)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a value to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter value: The value to send.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(<span class="number">_</span> input: Output)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a completion signal to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter completion: A `Completion` instance which indicates whether publishing has finished normally or failed with an error.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CurrentValueSubject</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A subject that wraps a single value and publishes a new element whenever the value changes.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Unlike ``PassthroughSubject``, ``CurrentValueSubject`` maintains a buffer of the most recently published element.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Calling ``CurrentValueSubject/send(_:)`` on a ``CurrentValueSubject`` also updates the current value, making it equivalent to updating the ``CurrentValueSubject/value`` directly.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentValueSubject</span>&lt;<span class="title">Output</span>, <span class="title">Failure</span>&gt; : <span class="title">Subject</span> <span class="title">where</span> <span class="title">Failure</span> : <span class="title">Error</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The value wrapped by this subject, published as a new element whenever it changes.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">Output</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Creates a current value subject with the given initial value.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter value: The initial value to publish.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> value: <span class="type">Output</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a subscription to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This call provides the ``Subject`` an opportunity to establish demand for any new upstream subscriptions.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscription: The subscription instance through which the subscriber can request elements.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(subscription: Subscription)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Attaches the specified subscriber to this publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Implementations of ``Publisher`` must implement this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(subscriber: S)</span></span> <span class="keyword">where</span> <span class="type">Output</span> == <span class="type">S</span>.<span class="type">Input</span>, <span class="type">Failure</span> == <span class="type">S</span>.<span class="type">Failure</span>, <span class="type">S</span> : <span class="type">Subscriber</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a value to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter value: The value to send.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(<span class="number">_</span> input: Output)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Sends a completion signal to the subscriber.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter completion: A `Completion` instance which indicates whether publishing has finished normally or failed with an error.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">send</span><span class="params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Scheduler">Scheduler</h3><h4 id="When">When</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A protocol that defines when and how to execute a closure.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// You can use a scheduler to execute code as soon as possible, or after a future date.</span></span><br><span class="line"><span class="comment">/// Individual scheduler implementations use whatever time-keeping system makes sense for them. Schedulers express this as their `SchedulerTimeType`. Since this type conforms to ``SchedulerTimeIntervalConvertible``, you can always express these times with the convenience functions like `.milliseconds(500)`. Schedulers can accept options to control how they execute the actions passed to them. These options may control factors like which threads or dispatch queues execute the actions.</span></span><br><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Describes an instant in time for this scheduler.</span></span><br><span class="line">    associatedtype <span class="type">SchedulerTimeType</span> : <span class="type">Strideable</span> <span class="keyword">where</span> <span class="type">Self</span>.<span class="type">SchedulerTimeType</span>.<span class="type">Stride</span> : <span class="type">SchedulerTimeIntervalConvertible</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A type that defines options accepted by the scheduler.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This type is freely definable by each `Scheduler`. Typically, operations that take a `Scheduler` parameter will also take `SchedulerOptions`.</span></span><br><span class="line">    associatedtype <span class="type">SchedulerOptions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// This scheduler’s definition of the current moment in time.</span></span><br><span class="line">    <span class="keyword">var</span> now: <span class="type">Self</span>.<span class="type">SchedulerTimeType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The minimum tolerance allowed by the scheduler.</span></span><br><span class="line">    <span class="keyword">var</span> minimumTolerance: <span class="type">Self</span>.<span class="type">SchedulerTimeType</span>.<span class="type">Stride</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Performs the action at the next possible opportunity.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">(options: <span class="keyword">Self</span>.SchedulerOptions?, <span class="number">_</span> action: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Performs the action at some time after the specified date.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">(after date: <span class="keyword">Self</span>.SchedulerTimeType, tolerance: <span class="keyword">Self</span>.SchedulerTimeType.Stride, options: <span class="keyword">Self</span>.SchedulerOptions?, <span class="number">_</span> action: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Performs the action at some time after the specified date, at the specified frequency, optionally taking into account tolerance if possible.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">(after date: <span class="keyword">Self</span>.SchedulerTimeType, interval: <span class="keyword">Self</span>.SchedulerTimeType.Stride, tolerance: <span class="keyword">Self</span>.SchedulerTimeType.Stride, options: <span class="keyword">Self</span>.SchedulerOptions?, <span class="number">_</span> action: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Cancellable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Where">Where</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">@available</span>(macOS <span class="number">10.15</span>, iOS <span class="number">13.0</span>, tvOS <span class="number">13.0</span>, watchOS <span class="number">6.0</span>, *)</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Publisher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Specifies the scheduler on which to receive elements from the publisher.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// You use the ``Publisher/receive(on:options:)`` operator to receive results and completion on a specific scheduler, such as performing UI work on the main run loop. In contrast with ``Publisher/subscribe(on:options:)``, which affects upstream messages, ``Publisher/receive(on:options:)`` changes the execution context of downstream messages.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// In the following example, the ``Publisher/subscribe(on:options:)`` operator causes `jsonPublisher` to receive requests on `backgroundQueue`, while the</span></span><br><span class="line">    <span class="comment">/// ``Publisher/receive(on:options:)`` causes `labelUpdater` to receive elements and completion on `RunLoop.main`.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     let jsonPublisher = MyJSONLoaderPublisher() // Some publisher.</span></span><br><span class="line">    <span class="comment">///     let labelUpdater = MyLabelUpdateSubscriber() // Some subscriber that updates the UI.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     jsonPublisher</span></span><br><span class="line">    <span class="comment">///         .subscribe(on: backgroundQueue)</span></span><br><span class="line">    <span class="comment">///         .receive(on: RunLoop.main)</span></span><br><span class="line">    <span class="comment">///         .subscribe(labelUpdater)</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Prefer ``Publisher/receive(on:options:)`` over explicit use of dispatch queues when performing work in subscribers. For example, instead of the following pattern:</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     pub.sink &#123;</span></span><br><span class="line">    <span class="comment">///         DispatchQueue.main.async &#123;</span></span><br><span class="line">    <span class="comment">///             // Do something.</span></span><br><span class="line">    <span class="comment">///         &#125;</span></span><br><span class="line">    <span class="comment">///     &#125;</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Use this pattern instead:</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     pub.receive(on: DispatchQueue.main).sink &#123;</span></span><br><span class="line">    <span class="comment">///         // Do something.</span></span><br><span class="line">    <span class="comment">///     &#125;</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///  &gt; Note: ``Publisher/receive(on:options:)`` doesn’t affect the scheduler used to call the subscriber’s ``Subscriber/receive(subscription:)`` method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - scheduler: The scheduler the publisher uses for element delivery.</span></span><br><span class="line">    <span class="comment">///   - options: Scheduler options used to customize element delivery.</span></span><br><span class="line">    <span class="comment">/// - Returns: A publisher that delivers elements using the specified scheduler.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">receive</span><span class="generics">&lt;S&gt;</span><span class="params">(on scheduler: S, options: S.SchedulerOptions? = <span class="literal">nil</span>)</span></span> -&gt; <span class="type">Publishers</span>.<span class="type">ReceiveOn</span>&lt;<span class="type">Self</span>, <span class="type">S</span>&gt; <span class="keyword">where</span> <span class="type">S</span> : <span class="type">Scheduler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/05/30/Combine-Introduction/" data-id="cl8wql7io002x03xkfp2q29ej" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/combine/">combine</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Swift-Source-Code-ContiguousArray" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/13/Swift-Source-Code-ContiguousArray/" class="article-date">
  <time datetime="2022-05-13T11:39:51.000Z" itemprop="datePublished">2022-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/13/Swift-Source-Code-ContiguousArray/">Swift Source Code: ContiguousArray</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ContiguousArray">ContiguousArray</h1><p>A contiguously stored array.</p>
<p><code>ContiguousArray&lt;Element&gt;</code> is the fastest and simplest of the three(ContiguousArray, Array, ArraySlice) – use this when you need “C array” performance. The elements of a <code>ContiguousArray</code> are always stored contiguously in memory.</p>
<p>The <code>ContiguousArray</code> type is a specialized array that always stores its elements in a contiguous region of memory. This contrasts with <code>Array</code>, which can store its elements in either a contiguous region of memory or an <code>NSArray</code> instance if its <code>Element</code> type is a class or <code>@objc</code> protocol.</p>
<p>If your array’s <code>Element</code> type is a class or <code>@objc</code> protocol and you do not need to bridge the array to <code>NSArray</code> or pass the array to Objective-C APIs, using <code>ContiguousArray</code> may be more efficient and have more predictable performance than <code>Array</code>. </p>
<p>If the array’s <code>Element</code> type is a struct or enumeration, <code>Array</code> and <code>ContiguousArray</code> should have similar efficiency.</p>
<p><code>ContiguousArray</code> 是对 <code>_buffer: _ContiguousArrayBuffer&lt;Element&gt;</code> 的一个封装.</p>
<p><code>_buffer</code> 是一个对 <code>_storage: __ContiguousArrayStorageBase</code>的封装.</p>
<h2 id="Types">Types</h2><h3 id="ContiguousArray-1">ContiguousArray</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">ContiguousArray</span>&lt;<span class="title">Element</span>&gt;: <span class="title">_DestructorSafeContainer</span> </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">typealias</span> _Buffer = _ContiguousArrayBuffer&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _buffer: _Buffer</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Initialization from an existing buffer does not have "array.init"</span></span><br><span class="line">  <span class="comment">/// semantics because the caller may retain an alias to buffer.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(_buffer: _Buffer) &#123;</span><br><span class="line">    <span class="keyword">self</span>._buffer = _buffer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="_ContiguousArrayBuffer:__ArrayBufferProtocol">_ContiguousArrayBuffer<element>: _ArrayBufferProtocol</element></h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@usableFromInline</span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">struct</span> <span class="title">_ContiguousArrayBuffer</span>&lt;<span class="title">Element</span>&gt;: <span class="title">_ArrayBufferProtocol</span> </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _storage: __ContiguousArrayStorageBase</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>//  __ContiguousArrayStorageBase supplies the implementation of the<br>//  _NSArrayCore API (and thus, NSArray the API) for our<br>//  _ContiguousArrayStorage<t>.  We can’t put this implementation<br>//  directly on _ContiguousArrayStorage because generic classes can’t<br>//  override Objective-C selectors.<br>//</t></p>
<h3 id="ContiguousArrayStorageBase:_SwiftNativeNSArrayWithContiguousStorage"><strong>ContiguousArrayStorageBase: </strong>SwiftNativeNSArrayWithContiguousStorage</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Base class of the heap buffer backing arrays.  </span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="doctag">NOTE:</span> older runtimes called this _ContiguousArrayStorageBase. The</span></span><br><span class="line"><span class="comment">/// two must coexist, so it was renamed. The old name must not be used</span></span><br><span class="line"><span class="comment">/// in the new runtime.</span></span><br><span class="line"><span class="comment">// 大部分方法需要子类实现</span></span><br><span class="line">@usableFromInline</span><br><span class="line">@_fixed_layout</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">__ContiguousArrayStorageBase</span>: <span class="title">__SwiftNativeNSArrayWithContiguousStorage</span> </span>&#123; </span><br><span class="line">  @<span class="type">Usablefrominline</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">var</span> countAndCapacity: _ArrayBody</span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="preprocessor">@nonobjc</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(_doNotCallMeBase: ()) &#123;</span><br><span class="line">    _internalInvariantFailure(<span class="string">"creating instance of __ContiguousArrayStorageBase"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">#<span class="keyword">if</span> _runtime(_ObjC)</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">withUnsafeBufferOfObjects</span><span class="generics">&lt;R&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> body: <span class="params">(UnsafeBufferPointer&lt;AnyObject&gt;)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">R</span></span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; <span class="type">R</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> result = <span class="keyword">try</span> _withVerbatimBridgedUnsafeBuffer(body) &#123;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Can't use a buffer of non-verbatim-bridged elements as an NSArray"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// If the stored type is bridged verbatim, invoke `body` on an</span></span><br><span class="line">  <span class="comment">/// `UnsafeBufferPointer` to the elements and return the result.</span></span><br><span class="line">  <span class="comment">/// Otherwise, return `nil`.</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">_withVerbatimBridgedUnsafeBuffer</span><span class="generics">&lt;R&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> body: <span class="params">(UnsafeBufferPointer&lt;AnyObject&gt;)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">R</span></span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; <span class="type">R</span>? &#123;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Concrete subclasses must implement _withVerbatimBridgedUnsafeBuffer"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">_getNonVerbatimBridgingBuffer</span><span class="params">()</span></span> -&gt; _BridgingBuffer &#123;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Concrete subclasses must implement _getNonVerbatimBridgingBuffer"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="preprocessor">@objc</span>(mutableCopyWithZone:)</span><br><span class="line">  <span class="keyword">dynamic</span> <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">mutableCopy</span><span class="params">(with <span class="number">_</span>: _SwiftNSZone?)</span></span> -&gt; <span class="type">AnyObject</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> arr = <span class="type">Array</span>&lt;<span class="type">AnyObject</span>&gt;(_ContiguousArrayBuffer(<span class="keyword">self</span>))</span><br><span class="line">    <span class="keyword">return</span> _SwiftNSMutableArray(arr)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="preprocessor">@objc</span>(indexOfObjectIdenticalTo:)</span><br><span class="line">  <span class="keyword">dynamic</span> <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">index</span><span class="params">(ofObjectIdenticalTo object: AnyObject)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> arr = <span class="type">Array</span>&lt;<span class="type">AnyObject</span>&gt;(_ContiguousArrayBuffer(<span class="keyword">self</span>))</span><br><span class="line">    <span class="keyword">return</span> arr.firstIndex &#123; $<span class="number">0</span> === object &#125; ?? <span class="type">NSNotFound</span></span><br><span class="line">  &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">@inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">canStoreElements</span><span class="params">(ofDynamicType <span class="number">_</span>: Any.<span class="keyword">Type</span>)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Concrete subclasses must implement canStoreElements(ofDynamicType:)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that every element in the array is.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> staticElementType: <span class="type">Any</span>.<span class="type">Type</span> &#123;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Concrete subclasses must implement staticElementType"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">deinit</span> &#123;</span><br><span class="line">    _internalInvariant(</span><br><span class="line">      <span class="keyword">self</span> !== _emptyArrayStorage, <span class="string">"Deallocating empty array storage?!"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接对内存进行操作</span></span><br><span class="line">@usableFromInline</span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">struct</span> <span class="title">_ContiguousArrayBuffer</span>&lt;<span class="title">Element</span>&gt;: <span class="title">_ArrayBufferProtocol</span> </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _storage: __ContiguousArrayStorageBase</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Make a buffer with uninitialized elements.  After using this</span></span><br><span class="line">  <span class="comment">/// method, you must either initialize the `count` elements at the</span></span><br><span class="line">  <span class="comment">/// result's `.firstElementAddress` or set the result's `.count`</span></span><br><span class="line">  <span class="comment">/// to zero.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(</span><br><span class="line">    _uninitializedCount uninitializedCount: <span class="type">Int</span>,</span><br><span class="line">    minimumCapacity: <span class="type">Int</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">let</span> realMinimumCapacity = <span class="type">Swift</span>.<span class="built_in">max</span>(uninitializedCount, minimumCapacity)</span><br><span class="line">    <span class="keyword">if</span> realMinimumCapacity == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">self</span> = _ContiguousArrayBuffer&lt;<span class="type">Element</span>&gt;()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 初始化一个`_ContiguousArrayStorage&lt;Element&gt;`的实例,</span></span><br><span class="line">      <span class="comment">// 并在后面申请`realMinimumCapacity`大小的连续内存</span></span><br><span class="line">      <span class="comment">// 然后更新StorageHeader</span></span><br><span class="line">      _storage = <span class="type">Builtin</span>.allocWithTailElems_1(</span><br><span class="line">         getContiguousArrayStorageType(<span class="keyword">for</span>: <span class="type">Element</span>.<span class="keyword">self</span>),</span><br><span class="line">         realMinimumCapacity._builtinWordValue, <span class="type">Element</span>.<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> storageAddr = <span class="type">UnsafeMutableRawPointer</span>(<span class="type">Builtin</span>.bridgeToRawPointer(_storage))</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> allocSize = _mallocSize(ofAllocation: storageAddr) &#123;</span><br><span class="line">        <span class="keyword">let</span> endAddr = storageAddr + allocSize</span><br><span class="line">        <span class="keyword">let</span> realCapacity = endAddr.assumingMemoryBound(to: <span class="type">Element</span>.<span class="keyword">self</span>) - firstElementAddress</span><br><span class="line">        _initStorageHeader(</span><br><span class="line">          <span class="built_in">count</span>: uninitializedCount, capacity: realCapacity)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _initStorageHeader(</span><br><span class="line">          <span class="built_in">count</span>: uninitializedCount, capacity: realMinimumCapacity)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Initialize the body part of our storage.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Warning: does not initialize elements</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">_initStorageHeader</span><span class="params">(<span class="built_in">count</span>: Int, capacity: Int)</span></span> &#123;</span><br><span class="line">#<span class="keyword">if</span> _runtime(_ObjC)</span><br><span class="line">    <span class="keyword">let</span> verbatim = _isBridgedVerbatimToObjectiveC(<span class="type">Element</span>.<span class="keyword">self</span>)</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    <span class="keyword">let</span> verbatim = <span class="literal">false</span></span><br><span class="line">#endif</span><br><span class="line">    <span class="comment">// 赋值`_storage`中的`countAndCapacity`</span></span><br><span class="line">    <span class="comment">// We can initialize by assignment because _ArrayBody is a trivial type,</span></span><br><span class="line">    <span class="comment">// i.e. contains no references.</span></span><br><span class="line">    _storage.countAndCapacity = _ArrayBody(</span><br><span class="line">      <span class="built_in">count</span>: <span class="built_in">count</span>,</span><br><span class="line">      capacity: capacity,</span><br><span class="line">      elementTypeIsBridgedVerbatim: verbatim)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">@frozen</span><br><span class="line">@usableFromInline</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">struct</span> <span class="title">_ArrayBody</span> </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _storage: _SwiftArrayBodyStorage</span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(</span><br><span class="line">    <span class="built_in">count</span>: <span class="type">Int</span>, capacity: <span class="type">Int</span>, elementTypeIsBridgedVerbatim: <span class="type">Bool</span> = <span class="literal">false</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    _internalInvariant(<span class="built_in">count</span> &gt;= <span class="number">0</span>)</span><br><span class="line">    _internalInvariant(capacity &gt;= <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    _storage = _SwiftArrayBodyStorage(</span><br><span class="line">      <span class="built_in">count</span>: <span class="built_in">count</span>,</span><br><span class="line">      _capacityAndFlags:</span><br><span class="line">        (<span class="type">UInt</span>(truncatingIfNeeded: capacity) &amp;&lt;&lt; <span class="number">1</span>) |</span><br><span class="line">        (elementTypeIsBridgedVerbatim ? <span class="number">1</span> : <span class="number">0</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">_SwiftArrayBodyStorage</span> </span>&#123;</span><br><span class="line">  __swift_intptr_t <span class="built_in">count</span>;</span><br><span class="line">  __swift_uintptr_t _capacityAndFlags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>// Swift Array 转换NSArray O(1)</p>
<h3 id="SwiftNativeNSArrayWithContiguousStorage_:_SwiftNativeNSArray_(NSArray)"><strong>SwiftNativeNSArrayWithContiguousStorage : </strong>SwiftNativeNSArray (NSArray)</h3><h3 id="__SwiftNativeNSArrayWithContiguousStorage_(non-objc)">__SwiftNativeNSArrayWithContiguousStorage (non-objc)</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An `NSArray` with Swift-native reference counting and contiguous</span></span><br><span class="line"><span class="comment">/// storage.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="doctag">NOTE:</span> older runtimes called this</span></span><br><span class="line"><span class="comment">/// _SwiftNativeNSArrayWithContiguousStorage. The two must coexist, so</span></span><br><span class="line"><span class="comment">/// it was renamed. The old name must not be used in the new runtime.</span></span><br><span class="line">@_fixed_layout</span><br><span class="line">@usableFromInline</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">__SwiftNativeNSArrayWithContiguousStorage</span></span><br><span class="line">  : <span class="title">__SwiftNativeNSArray</span> </span>&#123; <span class="comment">// Provides NSArray inheritance and native refcounting</span></span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="preprocessor">@nonobjc</span> <span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">init</span>() &#123; <span class="keyword">super</span>.<span class="keyword">init</span>() &#125;</span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">deinit</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Operate on our contiguous storage</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="func"><span class="keyword">func</span> <span class="title">withUnsafeBufferOfObjects</span><span class="generics">&lt;R&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> body: <span class="params">(UnsafeBufferPointer&lt;AnyObject&gt;)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">R</span></span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; <span class="type">R</span> &#123;</span><br><span class="line">    _internalInvariantFailure(</span><br><span class="line">      <span class="string">"Must override withUnsafeBufferOfObjects in derived classes"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@_fixed_layout</span><br><span class="line">@usableFromInline</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">__SwiftNativeNSArray</span> </span>&#123;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">deinit</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Empty shim version for non-objc platforms.</span></span><br><span class="line">@usableFromInline</span><br><span class="line">@_fixed_layout</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">__SwiftNativeNSArrayWithContiguousStorage</span> </span>&#123;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">deinit</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="__SwiftNativeNSArray">__SwiftNativeNSArray</h3><p>provides NSArray inheritance and native refcounting</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@_fixed_layout</span><br><span class="line">@usableFromInline</span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">__SwiftNativeNSArray</span> </span>&#123;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">deinit</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Functions">Functions</h2><h3 id="Copy_on_Write">Copy on Write</h3><p>以 <code>append</code> 为例:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Adds a new element at the end of the array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use this method to append a single element to the end of a mutable array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     var numbers = [1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="comment">///     numbers.append(100)</span></span><br><span class="line"><span class="comment">///     print(numbers)</span></span><br><span class="line"><span class="comment">///     // Prints "[1, 2, 3, 4, 5, 100]"</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Because arrays increase their allocated capacity using an exponential</span></span><br><span class="line"><span class="comment">/// strategy, appending a single element to an array is an O(1) operation</span></span><br><span class="line"><span class="comment">/// when averaged over many calls to the `append(_:)` method. When an array</span></span><br><span class="line"><span class="comment">/// has additional capacity and is not sharing its storage with another</span></span><br><span class="line"><span class="comment">/// instance, appending an element is O(1). When an array needs to</span></span><br><span class="line"><span class="comment">/// reallocate storage before appending or its storage is shared with</span></span><br><span class="line"><span class="comment">/// another copy, appending is O(*n*), where *n* is the length of the array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter newElement: The element to append to the array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(1) on average, over many calls to `append(_:)` on the</span></span><br><span class="line"><span class="comment">///   same array.</span></span><br><span class="line">@inlinable</span><br><span class="line">@_semantics(<span class="string">"array.append_element"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> newElement: __owned Element)</span></span> &#123;</span><br><span class="line">  <span class="comment">// Separating uniqueness check and capacity check allows hoisting the</span></span><br><span class="line">  <span class="comment">// uniqueness check out of a loop.</span></span><br><span class="line">  _makeUniqueAndReserveCapacityIfNotUnique()</span><br><span class="line">  <span class="keyword">let</span> oldCount = _buffer.mutableCount</span><br><span class="line">  _reserveCapacityAssumingUniqueBuffer(oldCount: oldCount)</span><br><span class="line">  _appendElementAssumeUniqueAndCapacity(oldCount, newElement: newElement)</span><br><span class="line">  _endMutation()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@inlinable</span><br><span class="line">@_semantics(<span class="string">"array.make_mutable"</span>)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">_makeUniqueAndReserveCapacityIfNotUnique</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> _slowPath(!_buffer.beginCOWMutation()) &#123;</span><br><span class="line">    _createNewBuffer(bufferIsUnique: <span class="literal">false</span>,</span><br><span class="line">                     minimumCapacity: <span class="built_in">count</span> &amp;+ <span class="number">1</span>,</span><br><span class="line">                     growForAppend: <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Creates a new buffer, replacing the current buffer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If `bufferIsUnique` is true, the buffer is assumed to be uniquely</span></span><br><span class="line"><span class="comment">/// referenced by this array and the elements are moved - instead of copied -</span></span><br><span class="line"><span class="comment">/// to the new buffer.</span></span><br><span class="line"><span class="comment">/// The `minimumCapacity` is the lower bound for the new capacity.</span></span><br><span class="line"><span class="comment">/// If `growForAppend` is true, the new capacity is calculated using</span></span><br><span class="line"><span class="comment">/// `_growArrayCapacity`.</span></span><br><span class="line">@_alwaysEmitIntoClient</span><br><span class="line">@inline(never)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">_createNewBuffer</span><span class="params">(</span><br><span class="line">  bufferIsUnique: Bool, minimumCapacity: Int, growForAppend: Bool</span><br><span class="line">)</span></span> &#123;</span><br><span class="line">  _internalInvariant(!bufferIsUnique || _buffer.<span class="built_in">isUniquelyReferenced</span>())</span><br><span class="line">  _buffer = _buffer._consumeAndCreateNew(bufferIsUnique: bufferIsUnique,</span><br><span class="line">                                         minimumCapacity: minimumCapacity,</span><br><span class="line">                                         growForAppend: growForAppend)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Creates and returns a new uniquely referenced buffer which is a copy of</span></span><br><span class="line"><span class="comment">/// this buffer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// If `bufferIsUnique` is true, the buffer is assumed to be uniquely</span></span><br><span class="line"><span class="comment">/// referenced and the elements are moved - instead of copied - to the new</span></span><br><span class="line"><span class="comment">/// buffer.</span></span><br><span class="line"><span class="comment">/// The `minimumCapacity` is the lower bound for the new capacity.</span></span><br><span class="line"><span class="comment">/// If `growForAppend` is true, the new capacity is calculated using</span></span><br><span class="line"><span class="comment">/// `_growArrayCapacity`, but at least kept at `minimumCapacity`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This buffer is consumed, i.e. it's released.</span></span><br><span class="line">@_alwaysEmitIntoClient</span><br><span class="line">@inline(never)</span><br><span class="line">@_semantics(<span class="string">"optimize.sil.specialize.owned2guarantee.never"</span>)</span><br><span class="line"><span class="keyword">internal</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">_consumeAndCreateNew</span><span class="params">(</span><br><span class="line">  bufferIsUnique: Bool, minimumCapacity: Int, growForAppend: Bool</span><br><span class="line">)</span></span> -&gt; _ArrayBuffer &#123;</span><br><span class="line">  <span class="keyword">let</span> newCapacity = _growArrayCapacity(oldCapacity: capacity,</span><br><span class="line">                                       minimumCapacity: minimumCapacity,</span><br><span class="line">                                       growForAppend: growForAppend)</span><br><span class="line">  <span class="keyword">let</span> <span class="built_in">c</span> = <span class="built_in">count</span></span><br><span class="line">  _internalInvariant(newCapacity &gt;= <span class="built_in">c</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> newBuffer = _ContiguousArrayBuffer&lt;<span class="type">Element</span>&gt;(</span><br><span class="line">    _uninitializedCount: <span class="built_in">c</span>, minimumCapacity: newCapacity)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 当buffer is Unique, 直接不进行copy，操作数据</span></span><br><span class="line">  <span class="keyword">if</span> bufferIsUnique &#123;</span><br><span class="line">    <span class="comment">// As an optimization, if the original buffer is unique, we can just move</span></span><br><span class="line">    <span class="comment">// the elements instead of copying.</span></span><br><span class="line">    <span class="keyword">let</span> dest = newBuffer.firstElementAddress</span><br><span class="line">    dest.moveInitialize(from: mutableFirstElementAddress,</span><br><span class="line">                        <span class="built_in">count</span>: <span class="built_in">c</span>)</span><br><span class="line">    _native.mutableCount = <span class="number">0</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/// 进行复制</span></span><br><span class="line">    _copyContents(</span><br><span class="line">      subRange: <span class="number">0</span>..&lt;<span class="built_in">c</span>,</span><br><span class="line">      initializing: newBuffer.mutableFirstElementAddress)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _ArrayBuffer(_buffer: newBuffer, shiftedToStartIndex: <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/05/13/Swift-Source-Code-ContiguousArray/" data-id="cl8wql7f1002003xk8eac1ihz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swift-source-code/">swift source code</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Swift-Source-Code-Collection" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/11/Swift-Source-Code-Collection/" class="article-date">
  <time datetime="2022-05-11T11:27:18.000Z" itemprop="datePublished">2022-05-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/11/Swift-Source-Code-Collection/">Swift Source Code: Collection</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Summary">Summary</h1><p>Collection extends Sequence. It guarantees that the sequence is multi-pass, and it allows you to look up elements by their indices. It also adds slicing capabilities via its SubSequence type, which is a collection itself.</p>
<h1 id="Types">Types</h1><h2 id="IndexingIterator">IndexingIterator</h2><ul>
<li><code>IndexingIterator</code> 是collection类型默认的iterator实现</li>
<li>自定义Collection所需要的最小实现只需要startIndex, endIndex, subscript方法</li>
<li><code>IndexingIterator</code>实现了<code>IteratorProtocol</code>, <code>Sequence</code>, <code>Sendable</code>等protocol</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A type that iterates over a collection using its indices.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The `IndexingIterator` type is the default iterator for any collection that</span></span><br><span class="line"><span class="comment">/// doesn't declare its own. It acts as an iterator by using a collection's</span></span><br><span class="line"><span class="comment">/// indices to step over each value in the collection. Most collections in the</span></span><br><span class="line"><span class="comment">/// standard library use `IndexingIterator` as their iterator.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// By default, any custom collection type you create will inherit a</span></span><br><span class="line"><span class="comment">/// `makeIterator()` method that returns an `IndexingIterator` instance,</span></span><br><span class="line"><span class="comment">/// making it unnecessary to declare your own. When creating a custom</span></span><br><span class="line"><span class="comment">/// collection type, add the minimal requirements of the `Collection`</span></span><br><span class="line"><span class="comment">/// protocol: starting and ending indices and a subscript for accessing</span></span><br><span class="line"><span class="comment">/// elements. With those elements defined, the inherited `makeIterator()`</span></span><br><span class="line"><span class="comment">/// method satisfies the requirements of the `Sequence` protocol.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Here's an example of a type that declares the minimal requirements for a</span></span><br><span class="line"><span class="comment">/// collection. The `CollectionOfTwo` structure is a fixed-size collection</span></span><br><span class="line"><span class="comment">/// that always holds two elements of a specific type.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     struct CollectionOfTwo&lt;Element&gt;: Collection &#123;</span></span><br><span class="line"><span class="comment">///         let elements: (Element, Element)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///         init(_ first: Element, _ second: Element) &#123;</span></span><br><span class="line"><span class="comment">///             self.elements = (first, second)</span></span><br><span class="line"><span class="comment">///         &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///         var startIndex: Int &#123; return 0 &#125;</span></span><br><span class="line"><span class="comment">///         var endIndex: Int   &#123; return 2 &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///         subscript(index: Int) -&gt; Element &#123;</span></span><br><span class="line"><span class="comment">///             switch index &#123;</span></span><br><span class="line"><span class="comment">///             case 0: return elements.0</span></span><br><span class="line"><span class="comment">///             case 1: return elements.1</span></span><br><span class="line"><span class="comment">///             default: fatalError("Index out of bounds.")</span></span><br><span class="line"><span class="comment">///             &#125;</span></span><br><span class="line"><span class="comment">///         &#125;</span></span><br><span class="line"><span class="comment">///         </span></span><br><span class="line"><span class="comment">///         func index(after i: Int) -&gt; Int &#123;</span></span><br><span class="line"><span class="comment">///             precondition(i &lt; endIndex, "Can't advance beyond endIndex")</span></span><br><span class="line"><span class="comment">///             return i + 1</span></span><br><span class="line"><span class="comment">///         &#125;</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Because `CollectionOfTwo` doesn't define its own `makeIterator()`</span></span><br><span class="line"><span class="comment">/// method or `Iterator` associated type, it uses the default iterator type,</span></span><br><span class="line"><span class="comment">/// `IndexingIterator`. This example shows how a `CollectionOfTwo` instance</span></span><br><span class="line"><span class="comment">/// can be created holding the values of a point, and then iterated over</span></span><br><span class="line"><span class="comment">/// using a `for`-`in` loop.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let point = CollectionOfTwo(15.0, 20.0)</span></span><br><span class="line"><span class="comment">///     for element in point &#123;</span></span><br><span class="line"><span class="comment">///         print(element)</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///     // Prints "15.0"</span></span><br><span class="line"><span class="comment">///     // Prints "20.0"</span></span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">IndexingIterator</span>&lt;<span class="title">Elements</span>: <span class="title">Collection</span>&gt; </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> _elements: <span class="type">Elements</span></span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _position: <span class="type">Elements</span>.<span class="type">Index</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Creates an iterator over the given collection.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  @inline(__always)</span><br><span class="line">  <span class="keyword">public</span> <span class="comment">/// @testable</span></span><br><span class="line">  <span class="keyword">init</span>(_elements: <span class="type">Elements</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>._elements = _elements</span><br><span class="line">    <span class="keyword">self</span>._position = _elements.startIndex</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Creates an iterator over the given collection.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  @inline(__always)</span><br><span class="line">  <span class="keyword">public</span> <span class="comment">/// @testable</span></span><br><span class="line">  <span class="keyword">init</span>(_elements: <span class="type">Elements</span>, _position: <span class="type">Elements</span>.<span class="type">Index</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>._elements = _elements</span><br><span class="line">    <span class="keyword">self</span>._position = _position</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">IndexingIterator</span>: <span class="title">IteratorProtocol</span>, <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Element</span> = <span class="type">Elements</span>.<span class="type">Element</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Iterator</span> = <span class="type">IndexingIterator</span>&lt;<span class="type">Elements</span>&gt;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">SubSequence</span> = <span class="type">AnySequence</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Advances to the next element and returns it, or `nil` if no next element</span></span><br><span class="line">  <span class="comment">/// exists.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Repeatedly calling this method returns all the elements of the underlying</span></span><br><span class="line">  <span class="comment">/// sequence in order. As soon as the sequence has run out of elements, all</span></span><br><span class="line">  <span class="comment">/// subsequent calls return `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This example shows how an iterator can be used explicitly to emulate a</span></span><br><span class="line">  <span class="comment">/// `for`-`in` loop. First, retrieve a sequence's iterator, and then call</span></span><br><span class="line">  <span class="comment">/// the iterator's `next()` method until it returns `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let numbers = [2, 3, 5, 7]</span></span><br><span class="line">  <span class="comment">///     var numbersIterator = numbers.makeIterator()</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     while let num = numbersIterator.next() &#123;</span></span><br><span class="line">  <span class="comment">///         print(num)</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // Prints "2"</span></span><br><span class="line">  <span class="comment">///     // Prints "3"</span></span><br><span class="line">  <span class="comment">///     // Prints "5"</span></span><br><span class="line">  <span class="comment">///     // Prints "7"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Returns: The next element in the underlying sequence if a next element</span></span><br><span class="line">  <span class="comment">///   exists; otherwise, `nil`.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  @inline(__always)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Elements</span>.<span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">if</span> _position == _elements.endIndex &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> element = _elements[_position]</span><br><span class="line">    _elements.formIndex(after: &amp;_position)</span><br><span class="line">    <span class="keyword">return</span> element</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">IndexingIterator</span>: <span class="title">Sendable</span></span><br><span class="line">  <span class="title">where</span> <span class="title">Elements</span>: <span class="title">Sendable</span>, <span class="title">Elements</span>.<span class="title">Index</span>: <span class="title">Sendable</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Collection">Collection</h2><p>A sequence whose elements can be traversed multiple times, nondestructively, and accessed by an indexed subscript.</p>
<ul>
<li>Accessing Individual Elements</li>
<li>Accessing Slices of a Collection</li>
<li>Traversing a Collection</li>
<li>Conforming to the Collection Protocol<ul>
<li>The <code>startIndex</code> and <code>endIndex</code> properties</li>
<li>A subscript</li>
<li><code>index(after:)</code></li>
</ul>
</li>
<li>Expected Performance<ul>
<li><code>startIndex</code> and <code>endIndex</code> and subscript access O(1)</li>
<li>forward or bidirectional collection accessing its <code>count</code> property is an O(n)</li>
</ul>
</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Collection</span>: <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> ideally this would be in MigrationSupport.swift, but it needs</span></span><br><span class="line">  <span class="comment">// to be on the protocol instead of as an extension</span></span><br><span class="line">  <span class="preprocessor">@available</span>(*, deprecated<span class="comment">/*, obsoleted: 5.0*/</span>, message: <span class="string">"all index distances are now of type Int"</span>)</span><br><span class="line">  <span class="keyword">typealias</span> <span class="type">IndexDistance</span> = <span class="type">Int</span>  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Associated type inference requires this.</span></span><br><span class="line">  <span class="keyword">override</span> associatedtype <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> &lt;rdar://problem/34142121&gt;</span></span><br><span class="line">  <span class="comment">// This typealias should be removed as it predates the source compatibility</span></span><br><span class="line">  <span class="comment">// guarantees of Swift 3, but it cannot due to a bug.</span></span><br><span class="line">  <span class="preprocessor">@available</span>(swift, deprecated: <span class="number">3.2</span>, obsoleted: <span class="number">5.0</span>, renamed: <span class="string">"Element"</span>)</span><br><span class="line">  <span class="keyword">typealias</span> _Element = <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that represents a position in the collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Valid indices consist of the position of every element and a</span></span><br><span class="line">  <span class="comment">/// "past the end" position that's not valid for use as a subscript</span></span><br><span class="line">  <span class="comment">/// argument.</span></span><br><span class="line">  associatedtype <span class="type">Index</span>: <span class="type">Comparable</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// The position of the first element in a nonempty collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// If the collection is empty, `startIndex` is equal to `endIndex`.</span></span><br><span class="line">  <span class="keyword">var</span> startIndex: <span class="type">Index</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/// The collection's "past the end" position---that is, the position one</span></span><br><span class="line">  <span class="comment">/// greater than the last valid subscript argument.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// When you need a range that includes the last element of a collection, use</span></span><br><span class="line">  <span class="comment">/// the half-open range operator (`..&lt;`) with `endIndex`. The `..&lt;` operator</span></span><br><span class="line">  <span class="comment">/// creates a range that doesn't include the upper bound, so it's always</span></span><br><span class="line">  <span class="comment">/// safe to use with `endIndex`. For example:</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let numbers = [10, 20, 30, 40, 50]</span></span><br><span class="line">  <span class="comment">///     if let index = numbers.firstIndex(of: 30) &#123;</span></span><br><span class="line">  <span class="comment">///         print(numbers[index ..&lt; numbers.endIndex])</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // Prints "[30, 40, 50]"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// If the collection is empty, `endIndex` is equal to `startIndex`.</span></span><br><span class="line">  <span class="keyword">var</span> endIndex: <span class="type">Index</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that provides the collection's iteration interface and</span></span><br><span class="line">  <span class="comment">/// encapsulates its iteration state.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// By default, a collection conforms to the `Sequence` protocol by</span></span><br><span class="line">  <span class="comment">/// supplying `IndexingIterator` as its associated `Iterator`</span></span><br><span class="line">  <span class="comment">/// type.</span></span><br><span class="line">  associatedtype <span class="type">Iterator</span> = <span class="type">IndexingIterator</span>&lt;<span class="type">Self</span>&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Only needed for associated type inference. Otherwise,</span></span><br><span class="line">  <span class="comment">// we get an `IndexingIterator` rather than properly deducing the</span></span><br><span class="line">  <span class="comment">// Iterator type from makeIterator(). &lt;rdar://problem/21539115&gt;</span></span><br><span class="line">  <span class="comment">/// Returns an iterator over the elements of the collection.</span></span><br><span class="line">  <span class="keyword">override</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">Iterator</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A collection representing a contiguous subrange of this collection's</span></span><br><span class="line">  <span class="comment">/// elements. The subsequence shares indices with the original collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The default subsequence type for collections that don't define their own</span></span><br><span class="line">  <span class="comment">/// is `Slice`.</span></span><br><span class="line">  associatedtype <span class="type">SubSequence</span>: <span class="type">Collection</span> = <span class="type">Slice</span>&lt;<span class="type">Self</span>&gt;</span><br><span class="line">  <span class="keyword">where</span> <span class="type">SubSequence</span>.<span class="type">Index</span> == <span class="type">Index</span>,</span><br><span class="line">        <span class="type">Element</span> == <span class="type">SubSequence</span>.<span class="type">Element</span>,</span><br><span class="line">        <span class="type">SubSequence</span>.<span class="type">SubSequence</span> == <span class="type">SubSequence</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Accesses the element at the specified position.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The following example accesses an element of an array through its</span></span><br><span class="line">  <span class="comment">/// subscript to print its value:</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     var streets = ["Adams", "Bryant", "Channing", "Douglas", "Evarts"]</span></span><br><span class="line">  <span class="comment">///     print(streets[1])</span></span><br><span class="line">  <span class="comment">///     // Prints "Bryant"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// You can subscript a collection with any valid index other than the</span></span><br><span class="line">  <span class="comment">/// collection's end index. The end index refers to the position one past</span></span><br><span class="line">  <span class="comment">/// the last element of a collection, so it doesn't correspond with an</span></span><br><span class="line">  <span class="comment">/// element.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter position: The position of the element to access. `position`</span></span><br><span class="line">  <span class="comment">///   must be a valid index of the collection that is not equal to the</span></span><br><span class="line">  <span class="comment">///   `endIndex` property.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1)</span></span><br><span class="line">  @_borrowed</span><br><span class="line">  <span class="keyword">subscript</span>(position: <span class="type">Index</span>) -&gt; <span class="type">Element</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Accesses a contiguous subrange of the collection's elements.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// For example, using a `PartialRangeFrom` range expression with an array</span></span><br><span class="line">  <span class="comment">/// accesses the subrange from the start of the range expression until the</span></span><br><span class="line">  <span class="comment">/// end of the array.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let streets = ["Adams", "Bryant", "Channing", "Douglas", "Evarts"]</span></span><br><span class="line">  <span class="comment">///     let streetsSlice = streets[2..&lt;5]</span></span><br><span class="line">  <span class="comment">///     print(streetsSlice)</span></span><br><span class="line">  <span class="comment">///     // ["Channing", "Douglas", "Evarts"]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The accessed slice uses the same indices for the same elements as the</span></span><br><span class="line">  <span class="comment">/// original collection. This example searches `streetsSlice` for one of the</span></span><br><span class="line">  <span class="comment">/// strings in the slice, and then uses that index in the original array.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let index = streetsSlice.firstIndex(of: "Evarts")!    // 4</span></span><br><span class="line">  <span class="comment">///     print(streets[index])</span></span><br><span class="line">  <span class="comment">///     // "Evarts"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Always use the slice's `startIndex` property instead of assuming that its</span></span><br><span class="line">  <span class="comment">/// indices start at a particular value. Attempting to access an element by</span></span><br><span class="line">  <span class="comment">/// using an index outside the bounds of the slice may result in a runtime</span></span><br><span class="line">  <span class="comment">/// error, even if that index is valid for the original collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     print(streetsSlice.startIndex)</span></span><br><span class="line">  <span class="comment">///     // 2</span></span><br><span class="line">  <span class="comment">///     print(streetsSlice[2])</span></span><br><span class="line">  <span class="comment">///     // "Channing"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     print(streetsSlice[0])</span></span><br><span class="line">  <span class="comment">///     // error: Index out of bounds</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter bounds: A range of the collection's indices. The bounds of</span></span><br><span class="line">  <span class="comment">///   the range must be valid indices of the collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1)</span></span><br><span class="line">  <span class="keyword">subscript</span>(bounds: <span class="type">Range</span>&lt;<span class="type">Index</span>&gt;) -&gt; <span class="type">SubSequence</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that represents the indices that are valid for subscripting the</span></span><br><span class="line">  <span class="comment">/// collection, in ascending order.</span></span><br><span class="line">  associatedtype <span class="type">Indices</span>: <span class="type">Collection</span> = <span class="type">DefaultIndices</span>&lt;<span class="type">Self</span>&gt;</span><br><span class="line">    <span class="keyword">where</span> <span class="type">Indices</span>.<span class="type">Element</span> == <span class="type">Index</span>, </span><br><span class="line">          <span class="type">Indices</span>.<span class="type">Index</span> == <span class="type">Index</span>,</span><br><span class="line">          <span class="type">Indices</span>.<span class="type">SubSequence</span> == <span class="type">Indices</span></span><br><span class="line">        </span><br><span class="line">  <span class="comment">/// The indices that are valid for subscripting the collection, in ascending</span></span><br><span class="line">  <span class="comment">/// order.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A collection's `indices` property can hold a strong reference to the</span></span><br><span class="line">  <span class="comment">/// collection itself, causing the collection to be nonuniquely referenced.</span></span><br><span class="line">  <span class="comment">/// If you mutate the collection while iterating over its indices, a strong</span></span><br><span class="line">  <span class="comment">/// reference can result in an unexpected copy of the collection. To avoid</span></span><br><span class="line">  <span class="comment">/// the unexpected copy, use the `index(after:)` method starting with</span></span><br><span class="line">  <span class="comment">/// `startIndex` to produce indices instead.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     var c = MyFancyCollection([10, 20, 30, 40, 50])</span></span><br><span class="line">  <span class="comment">///     var i = c.startIndex</span></span><br><span class="line">  <span class="comment">///     while i != c.endIndex &#123;</span></span><br><span class="line">  <span class="comment">///         c[i] /= 5</span></span><br><span class="line">  <span class="comment">///         i = c.index(after: i)</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // c == MyFancyCollection([2, 4, 6, 8, 10])</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">indices</span>: <span class="type">Indices</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A Boolean value indicating whether the collection is empty.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// When you need to check whether your collection is empty, use the</span></span><br><span class="line">  <span class="comment">/// `isEmpty` property instead of checking that the `count` property is</span></span><br><span class="line">  <span class="comment">/// equal to zero. For collections that don't conform to</span></span><br><span class="line">  <span class="comment">/// `RandomAccessCollection`, accessing the `count` property iterates</span></span><br><span class="line">  <span class="comment">/// through the elements of the collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let horseName = "Silver"</span></span><br><span class="line">  <span class="comment">///     if horseName.isEmpty &#123;</span></span><br><span class="line">  <span class="comment">///         print("My horse has no name.")</span></span><br><span class="line">  <span class="comment">///     &#125; else &#123;</span></span><br><span class="line">  <span class="comment">///         print("Hi ho, \(horseName)!")</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // Prints "Hi ho, Silver!"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1)</span></span><br><span class="line">  <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// The number of elements in the collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// To check whether a collection is empty, use its `isEmpty` property</span></span><br><span class="line">  <span class="comment">/// instead of comparing `count` to zero. Unless the collection guarantees</span></span><br><span class="line">  <span class="comment">/// random-access performance, calculating `count` can be an O(*n*)</span></span><br><span class="line">  <span class="comment">/// operation.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1) if the collection conforms to</span></span><br><span class="line">  <span class="comment">///   `RandomAccessCollection`; otherwise, O(*n*), where *n* is the length</span></span><br><span class="line">  <span class="comment">///   of the collection.</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// The following requirements enable dispatching for firstIndex(of:) and</span></span><br><span class="line">  <span class="comment">// lastIndex(of:) when the element type is Equatable.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns `Optional(Optional(index))` if an element was found</span></span><br><span class="line">  <span class="comment">/// or `Optional(nil)` if an element was determined to be missing;</span></span><br><span class="line">  <span class="comment">/// otherwise, `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(*n*), where *n* is the length of the collection.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_customIndexOfEquatableElement</span><span class="params">(<span class="number">_</span> element: Element)</span></span> -&gt; <span class="type">Index</span>??</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Customization point for `Collection.lastIndex(of:)`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Define this method if the collection can find an element in less than</span></span><br><span class="line">  <span class="comment">/// O(*n*) by exploiting collection-specific knowledge.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Returns: `nil` if a linear search should be attempted instead,</span></span><br><span class="line">  <span class="comment">///   `Optional(nil)` if the element was not found, or</span></span><br><span class="line">  <span class="comment">///   `Optional(Optional(index))` if an element was found.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: Hopefully less than O(`count`).</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_customLastIndexOfEquatableElement</span><span class="params">(<span class="number">_</span> element: Element)</span></span> -&gt; <span class="type">Index</span>??</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns an index that is the specified distance from the given index.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The following example obtains an index advanced four positions from a</span></span><br><span class="line">  <span class="comment">/// string's starting index and then prints the character at that position.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let s = "Swift"</span></span><br><span class="line">  <span class="comment">///     let i = s.index(s.startIndex, offsetBy: 4)</span></span><br><span class="line">  <span class="comment">///     print(s[i])</span></span><br><span class="line">  <span class="comment">///     // Prints "t"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The value passed as `distance` must not offset `i` beyond the bounds of</span></span><br><span class="line">  <span class="comment">/// the collection.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameters:</span></span><br><span class="line">  <span class="comment">///   - i: A valid index of the collection.</span></span><br><span class="line">  <span class="comment">///   - distance: The distance to offset `i`. `distance` must not be negative</span></span><br><span class="line">  <span class="comment">///     unless the collection conforms to the `BidirectionalCollection`</span></span><br><span class="line">  <span class="comment">///     protocol.</span></span><br><span class="line">  <span class="comment">/// - Returns: An index offset by `distance` from the index `i`. If</span></span><br><span class="line">  <span class="comment">///   `distance` is positive, this is the same value as the result of</span></span><br><span class="line">  <span class="comment">///   `distance` calls to `index(after:)`. If `distance` is negative, this</span></span><br><span class="line">  <span class="comment">///   is the same value as the result of `abs(distance)` calls to</span></span><br><span class="line">  <span class="comment">///   `index(before:)`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1) if the collection conforms to</span></span><br><span class="line">  <span class="comment">///   `RandomAccessCollection`; otherwise, O(*k*), where *k* is the absolute</span></span><br><span class="line">  <span class="comment">///   value of `distance`.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">index</span><span class="params">(<span class="number">_</span> i: Index, offsetBy <span class="built_in">distance</span>: Int)</span></span> -&gt; <span class="type">Index</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns an index that is the specified distance from the given index,</span></span><br><span class="line">  <span class="comment">/// unless that distance is beyond a given limiting index.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The following example obtains an index advanced four positions from a</span></span><br><span class="line">  <span class="comment">/// string's starting index and then prints the character at that position.</span></span><br><span class="line">  <span class="comment">/// The operation doesn't require going beyond the limiting `s.endIndex`</span></span><br><span class="line">  <span class="comment">/// value, so it succeeds.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let s = "Swift"</span></span><br><span class="line">  <span class="comment">///     if let i = s.index(s.startIndex, offsetBy: 4, limitedBy: s.endIndex) &#123;</span></span><br><span class="line">  <span class="comment">///         print(s[i])</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // Prints "t"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The next example attempts to retrieve an index six positions from</span></span><br><span class="line">  <span class="comment">/// `s.startIndex` but fails, because that distance is beyond the index</span></span><br><span class="line">  <span class="comment">/// passed as `limit`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let j = s.index(s.startIndex, offsetBy: 6, limitedBy: s.endIndex)</span></span><br><span class="line">  <span class="comment">///     print(j)</span></span><br><span class="line">  <span class="comment">///     // Prints "nil"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The value passed as `distance` must not offset `i` beyond the bounds of</span></span><br><span class="line">  <span class="comment">/// the collection, unless the index passed as `limit` prevents offsetting</span></span><br><span class="line">  <span class="comment">/// beyond those bounds.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameters:</span></span><br><span class="line">  <span class="comment">///   - i: A valid index of the collection.</span></span><br><span class="line">  <span class="comment">///   - distance: The distance to offset `i`. `distance` must not be negative</span></span><br><span class="line">  <span class="comment">///     unless the collection conforms to the `BidirectionalCollection`</span></span><br><span class="line">  <span class="comment">///     protocol.</span></span><br><span class="line">  <span class="comment">///   - limit: A valid index of the collection to use as a limit. If</span></span><br><span class="line">  <span class="comment">///     `distance &gt; 0`, a limit that is less than `i` has no effect.</span></span><br><span class="line">  <span class="comment">///     Likewise, if `distance &lt; 0`, a limit that is greater than `i` has no</span></span><br><span class="line">  <span class="comment">///     effect.</span></span><br><span class="line">  <span class="comment">/// - Returns: An index offset by `distance` from the index `i`, unless that</span></span><br><span class="line">  <span class="comment">///   index would be beyond `limit` in the direction of movement. In that</span></span><br><span class="line">  <span class="comment">///   case, the method returns `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1) if the collection conforms to</span></span><br><span class="line">  <span class="comment">///   `RandomAccessCollection`; otherwise, O(*k*), where *k* is the absolute</span></span><br><span class="line">  <span class="comment">///   value of `distance`.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">index</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> i: Index, offsetBy <span class="built_in">distance</span>: Int, limitedBy limit: Index</span><br><span class="line">  )</span></span> -&gt; <span class="type">Index</span>?</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns the distance between two indices.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Unless the collection conforms to the `BidirectionalCollection` protocol,</span></span><br><span class="line">  <span class="comment">/// `start` must be less than or equal to `end`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameters:</span></span><br><span class="line">  <span class="comment">///   - start: A valid index of the collection.</span></span><br><span class="line">  <span class="comment">///   - end: Another valid index of the collection. If `end` is equal to</span></span><br><span class="line">  <span class="comment">///     `start`, the result is zero.</span></span><br><span class="line">  <span class="comment">/// - Returns: The distance between `start` and `end`. The result can be</span></span><br><span class="line">  <span class="comment">///   negative only if the collection conforms to the</span></span><br><span class="line">  <span class="comment">///   `BidirectionalCollection` protocol.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1) if the collection conforms to</span></span><br><span class="line">  <span class="comment">///   `RandomAccessCollection`; otherwise, O(*k*), where *k* is the</span></span><br><span class="line">  <span class="comment">///   resulting distance.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">distance</span><span class="params">(from start: Index, to end: Index)</span></span> -&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Performs a range check in O(1), or a no-op when a range check is not</span></span><br><span class="line">  <span class="comment">/// implementable in O(1).</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The range check, if performed, is equivalent to:</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     precondition(bounds.contains(index))</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Use this function to perform a cheap range check for QoI purposes when</span></span><br><span class="line">  <span class="comment">/// memory safety is not a concern.  Do not rely on this range check for</span></span><br><span class="line">  <span class="comment">/// memory safety.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The default implementation for forward and bidirectional indices is a</span></span><br><span class="line">  <span class="comment">/// no-op.  The default implementation for random access indices performs a</span></span><br><span class="line">  <span class="comment">/// range check.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1).</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_failEarlyRangeCheck</span><span class="params">(<span class="number">_</span> index: Index, bounds: Range&lt;Index&gt;)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_failEarlyRangeCheck</span><span class="params">(<span class="number">_</span> index: Index, bounds: ClosedRange&lt;Index&gt;)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Performs a range check in O(1), or a no-op when a range check is not</span></span><br><span class="line">  <span class="comment">/// implementable in O(1).</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The range check, if performed, is equivalent to:</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     precondition(</span></span><br><span class="line">  <span class="comment">///       bounds.contains(range.lowerBound) ||</span></span><br><span class="line">  <span class="comment">///       range.lowerBound == bounds.upperBound)</span></span><br><span class="line">  <span class="comment">///     precondition(</span></span><br><span class="line">  <span class="comment">///       bounds.contains(range.upperBound) ||</span></span><br><span class="line">  <span class="comment">///       range.upperBound == bounds.upperBound)</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Use this function to perform a cheap range check for QoI purposes when</span></span><br><span class="line">  <span class="comment">/// memory safety is not a concern.  Do not rely on this range check for</span></span><br><span class="line">  <span class="comment">/// memory safety.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The default implementation for forward and bidirectional indices is a</span></span><br><span class="line">  <span class="comment">/// no-op.  The default implementation for random access indices performs a</span></span><br><span class="line">  <span class="comment">/// range check.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1).</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_failEarlyRangeCheck</span><span class="params">(<span class="number">_</span> range: Range&lt;Index&gt;, bounds: Range&lt;Index&gt;)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns the position immediately after the given index.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The successor of an index must be well defined. For an index `i` into a</span></span><br><span class="line">  <span class="comment">/// collection `c`, calling `c.index(after: i)` returns the same index every</span></span><br><span class="line">  <span class="comment">/// time.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter i: A valid index of the collection. `i` must be less than</span></span><br><span class="line">  <span class="comment">///   `endIndex`.</span></span><br><span class="line">  <span class="comment">/// - Returns: The index value immediately after `i`.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">index</span><span class="params">(after i: Index)</span></span> -&gt; <span class="type">Index</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Replaces the given index with its successor.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter i: A valid index of the collection. `i` must be less than</span></span><br><span class="line">  <span class="comment">///   `endIndex`.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">formIndex</span><span class="params">(after i: <span class="keyword">inout</span> Index)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Functions">Functions</h1><h2 id="randomeElement">randomeElement</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/// 这两个方法我觉得可以用在测试代码中，如可以方便的随机选取登陆用户账号密码用于测试，或者随机一个dataset传入要测试的方法中</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">randomElement</span><span class="generics">&lt;T: RandomNumberGenerator&gt;</span><span class="params">(</span><br><span class="line">    using generator: <span class="keyword">inout</span> T</span><br><span class="line">  )</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">guard</span> !isEmpty <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> random = <span class="type">Int</span>.random(<span class="keyword">in</span>: <span class="number">0</span> ..&lt; <span class="built_in">count</span>, using: &amp;generator)</span><br><span class="line">    <span class="keyword">let</span> idx = index(startIndex, offsetBy: random)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>[idx]</span><br><span class="line">  &#125;</span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">randomElement</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">var</span> g = <span class="type">SystemRandomNumberGenerator</span>()</span><br><span class="line">    <span class="keyword">return</span> randomElement(using: &amp;g)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// The system's default source of random data.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// When you generate random values, shuffle a collection, or perform another</span></span><br><span class="line"><span class="comment">/// operation that depends on random data, this type is the generator used by</span></span><br><span class="line"><span class="comment">/// default. For example, the two method calls in this example are equivalent:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let x = Int.random(in: 1...100)</span></span><br><span class="line"><span class="comment">///     var g = SystemRandomNumberGenerator()</span></span><br><span class="line"><span class="comment">///     let y = Int.random(in: 1...100, using: &amp;g)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// `SystemRandomNumberGenerator` is automatically seeded, is safe to use in</span></span><br><span class="line"><span class="comment">/// multiple threads, and uses a cryptographically secure algorithm whenever</span></span><br><span class="line"><span class="comment">/// possible.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Platform Implementation of `SystemRandomNumberGenerator`</span></span><br><span class="line"><span class="comment">/// ========================================================</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// While the system generator is automatically seeded and thread-safe on every</span></span><br><span class="line"><span class="comment">/// platform, the cryptographic quality of the stream of random data produced by</span></span><br><span class="line"><span class="comment">/// the generator may vary. For more detail, see the documentation for the APIs</span></span><br><span class="line"><span class="comment">/// used by each platform.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Apple platforms use `arc4random_buf(3)`.</span></span><br><span class="line"><span class="comment">/// - Linux platforms use `getrandom(2)` when available; otherwise, they read</span></span><br><span class="line"><span class="comment">///   from `/dev/urandom`.</span></span><br><span class="line"><span class="comment">/// - Windows uses `BCryptGenRandom`</span></span><br><span class="line">  @frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">SystemRandomNumberGenerator</span>: <span class="title">RandomNumberGenerator</span>, <span class="title">Sendable</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Creates a new instance of the system's default random number generator.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns a value from a uniform, independent distribution of binary data.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Returns: An unsigned 64-bit random value.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">UInt64</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> random: <span class="type">UInt64</span> = <span class="number">0</span></span><br><span class="line">    swift_stdlib_random(&amp;random, <span class="type">MemoryLayout</span>&lt;<span class="type">UInt64</span>&gt;.size)</span><br><span class="line">    <span class="keyword">return</span> random</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="popFirst">popFirst</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Removes and returns the first element of the collection.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Returns: The first element of the collection if the collection is</span></span><br><span class="line"><span class="comment">///   not empty; otherwise, `nil`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(1)</span></span><br><span class="line">@inlinable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">popFirst</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> swift-3-indexing-model - review the following</span></span><br><span class="line">  <span class="keyword">guard</span> !isEmpty <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">  <span class="comment">/// 一定有倔种来告诉我，我们在swift不推荐使用“!”</span></span><br><span class="line">  <span class="keyword">let</span> element = first!</span><br><span class="line">  <span class="comment">/// 你删除first这么带劲吗？</span></span><br><span class="line">  <span class="keyword">self</span> = <span class="keyword">self</span>[index(after: startIndex)..&lt;endIndex]</span><br><span class="line">  <span class="keyword">return</span> element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="isEmpty">isEmpty</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// isEmpty 有什么值得写的？请认真看看下面的注视</span></span><br><span class="line"><span class="comment">/// A Boolean value indicating whether the collection is empty.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// When you need to check whether your collection is empty, use the</span></span><br><span class="line"><span class="comment">/// `isEmpty` property instead of checking that the `count` property is</span></span><br><span class="line"><span class="comment">/// equal to zero. For collections that don't conform to</span></span><br><span class="line"><span class="comment">/// `RandomAccessCollection`, accessing the `count` property iterates</span></span><br><span class="line"><span class="comment">/// through the elements of the collection.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let horseName = "Silver"</span></span><br><span class="line"><span class="comment">///     if horseName.isEmpty &#123;</span></span><br><span class="line"><span class="comment">///         print("My horse has no name.")</span></span><br><span class="line"><span class="comment">///     &#125; else &#123;</span></span><br><span class="line"><span class="comment">///         print("Hi ho, \(horseName)!")</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///     // Prints "Hi ho, Silver!")</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(1)</span></span><br><span class="line">@inlinable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> startIndex == endIndex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/05/11/Swift-Source-Code-Collection/" data-id="cl8wql7f8002203xkpsscxio0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swift-source-code/">swift source code</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Swift-Source-Code-Sequence" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/04/Swift-Source-Code-Sequence/" class="article-date">
  <time datetime="2022-05-04T03:23:21.000Z" itemprop="datePublished">2022-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/04/Swift-Source-Code-Sequence/">Swift Source Code: Sequence</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Summary">Summary</h1><p>Sequence provides iteration. It allows you to create an iterator, but there are no guarantees about whether the sequence is single-pass (e.g. reading from standard input) or multi-pass (iterating over an array).</p>
<h1 id="Types">Types</h1><h2 id="IteratorProtocol">IteratorProtocol</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// The type of element traversed by the iterator.</span></span><br><span class="line">  associatedtype <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Advances to the next element and returns it, or `nil` if no next element</span></span><br><span class="line">  <span class="comment">/// exists.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Repeatedly calling this method returns, in order, all the elements of the</span></span><br><span class="line">  <span class="comment">/// underlying sequence. As soon as the sequence has run out of elements, all</span></span><br><span class="line">  <span class="comment">/// subsequent calls return `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// You must not call this method if any other copy of this iterator has been</span></span><br><span class="line">  <span class="comment">/// advanced with a call to its `next()` method.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The following example shows how an iterator can be used explicitly to</span></span><br><span class="line">  <span class="comment">/// emulate a `for`-`in` loop. First, retrieve a sequence's iterator, and</span></span><br><span class="line">  <span class="comment">/// then call the iterator's `next()` method until it returns `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let numbers = [2, 3, 5, 7]</span></span><br><span class="line">  <span class="comment">///     var numbersIterator = numbers.makeIterator()</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     while let num = numbersIterator.next() &#123;</span></span><br><span class="line">  <span class="comment">///         print(num)</span></span><br><span class="line">  <span class="comment">///     &#125;</span></span><br><span class="line">  <span class="comment">///     // Prints "2"</span></span><br><span class="line">  <span class="comment">///     // Prints "3"</span></span><br><span class="line">  <span class="comment">///     // Prints "5"</span></span><br><span class="line">  <span class="comment">///     // Prints "7"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Returns: The next element in the underlying sequence, if a next element</span></span><br><span class="line">  <span class="comment">///   exists; otherwise, `nil`.</span></span><br><span class="line">  <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Element</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sequence">Sequence</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// A type representing the sequence's elements.</span></span><br><span class="line">  associatedtype <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that provides the sequence's iteration interface and</span></span><br><span class="line">  <span class="comment">/// encapsulates its iteration state.</span></span><br><span class="line">  associatedtype <span class="type">Iterator</span>: <span class="type">IteratorProtocol</span> <span class="keyword">where</span> <span class="type">Iterator</span>.<span class="type">Element</span> == <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> &lt;rdar://problem/34142121&gt;</span></span><br><span class="line">  <span class="comment">// This typealias should be removed as it predates the source compatibility</span></span><br><span class="line">  <span class="comment">// guarantees of Swift 3, but it cannot due to a bug.</span></span><br><span class="line">  <span class="preprocessor">@available</span>(*, unavailable, renamed: <span class="string">"Iterator"</span>)</span><br><span class="line">  <span class="keyword">typealias</span> <span class="type">Generator</span> = <span class="type">Iterator</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A type that represents a subsequence of some of the sequence's elements.</span></span><br><span class="line">  <span class="comment">// associatedtype SubSequence: Sequence = AnySequence&lt;Element&gt;</span></span><br><span class="line">  <span class="comment">//   where Element == SubSequence.Element,</span></span><br><span class="line">  <span class="comment">//         SubSequence.SubSequence == SubSequence</span></span><br><span class="line">  <span class="comment">// typealias SubSequence = AnySequence&lt;Element&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Returns an iterator over the elements of this sequence.</span></span><br><span class="line">  __consuming <span class="func"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">Iterator</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// A value less than or equal to the number of elements in the sequence,</span></span><br><span class="line">  <span class="comment">/// calculated nondestructively.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The default implementation returns 0. If you provide your own</span></span><br><span class="line">  <span class="comment">/// implementation, make sure to compute the value nondestructively.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(1), except if the sequence also conforms to `Collection`.</span></span><br><span class="line">  <span class="comment">///   In this case, see the documentation of `Collection.underestimatedCount`.</span></span><br><span class="line">  <span class="keyword">var</span> underestimatedCount: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">_customContainsEquatableElement</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> element: Element</span><br><span class="line">  )</span></span> -&gt; <span class="type">Bool</span>?</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Create a native array buffer containing the elements of `self`,</span></span><br><span class="line">  <span class="comment">/// in the same order.</span></span><br><span class="line">  __consuming <span class="func"><span class="keyword">func</span> <span class="title">_copyToContiguousArray</span><span class="params">()</span></span> -&gt; <span class="type">ContiguousArray</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Copy `self` into an unsafe buffer, initializing its memory.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The default implementation simply iterates over the elements of the</span></span><br><span class="line">  <span class="comment">/// sequence, initializing the buffer one item at a time.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// For sequences whose elements are stored in contiguous chunks of memory,</span></span><br><span class="line">  <span class="comment">/// it may be more efficient to copy them in bulk, using the</span></span><br><span class="line">  <span class="comment">/// `UnsafeMutablePointer.initialize(from:count:)` method.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter ptr: An unsafe buffer addressing uninitialized memory. The</span></span><br><span class="line">  <span class="comment">///    buffer must be of sufficient size to accommodate</span></span><br><span class="line">  <span class="comment">///    `source.underestimatedCount` elements. (Some implementations trap</span></span><br><span class="line">  <span class="comment">///    if given a buffer that's smaller than this.)</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Returns: `(it, c)`, where `c` is the number of elements copied into the</span></span><br><span class="line">  <span class="comment">///    buffer, and `it` is a partially consumed iterator that can be used to</span></span><br><span class="line">  <span class="comment">///    retrieve elements that did not fit into the buffer (if any). (This can</span></span><br><span class="line">  <span class="comment">///    only happen if `underestimatedCount` turned out to be an actual</span></span><br><span class="line">  <span class="comment">///    underestimate, and the buffer did not contain enough space to hold the</span></span><br><span class="line">  <span class="comment">///    entire sequence.)</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///    On return, the memory region in `buffer[0 ..&lt; c]` is initialized to</span></span><br><span class="line">  <span class="comment">///    the first `c` elements in the sequence.</span></span><br><span class="line">  __consuming <span class="func"><span class="keyword">func</span> <span class="title">_copyContents</span><span class="params">(</span><br><span class="line">    initializing ptr: UnsafeMutableBufferPointer&lt;Element&gt;</span><br><span class="line">  )</span></span> -&gt; (<span class="type">Iterator</span>,<span class="type">UnsafeMutableBufferPointer</span>&lt;<span class="type">Element</span>&gt;.<span class="type">Index</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Executes a closure on the sequence’s contiguous storage.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This method calls `body(buffer)`, where `buffer` is a pointer to the</span></span><br><span class="line">  <span class="comment">/// collection’s contiguous storage. If the contiguous storage doesn't exist,</span></span><br><span class="line">  <span class="comment">/// the collection creates it. If the collection doesn’t support an internal</span></span><br><span class="line">  <span class="comment">/// representation in a form of contiguous storage, the method doesn’t call</span></span><br><span class="line">  <span class="comment">/// `body` --- it immediately returns `nil`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// The optimizer can often eliminate bounds- and uniqueness-checking</span></span><br><span class="line">  <span class="comment">/// within an algorithm. When that fails, however, invoking the same</span></span><br><span class="line">  <span class="comment">/// algorithm on the `buffer` argument may let you trade safety for speed.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Successive calls to this method may provide a different pointer on each</span></span><br><span class="line">  <span class="comment">/// call. Don't store `buffer` outside of this method.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// A `Collection` that provides its own implementation of this method</span></span><br><span class="line">  <span class="comment">/// must provide contiguous storage to its elements in the same order</span></span><br><span class="line">  <span class="comment">/// as they appear in the collection. This guarantees that it's possible to</span></span><br><span class="line">  <span class="comment">/// generate contiguous mutable storage to any of its subsequences by slicing</span></span><br><span class="line">  <span class="comment">/// `buffer` with a range formed from the distances to the subsequence's</span></span><br><span class="line">  <span class="comment">/// `startIndex` and `endIndex`, respectively.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameters:</span></span><br><span class="line">  <span class="comment">///   - body: A closure that receives an `UnsafeBufferPointer` to the</span></span><br><span class="line">  <span class="comment">///     sequence's contiguous storage.</span></span><br><span class="line">  <span class="comment">/// - Returns: The value returned from `body`, unless the sequence doesn't</span></span><br><span class="line">  <span class="comment">///   support contiguous storage, in which case the method ignores `body` and</span></span><br><span class="line">  <span class="comment">///   returns `nil`.</span></span><br><span class="line">  <span class="func"><span class="keyword">func</span> <span class="title">withContiguousStorageIfAvailable</span><span class="generics">&lt;R&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> body: <span class="params">(<span class="number">_</span> buffer: UnsafeBufferPointer&lt;Element&gt;)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">R</span></span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; <span class="type">R</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DropFirstSequence,_PrefixSequence,_DropWhileSequence">DropFirstSequence, PrefixSequence, DropWhileSequence</h2><p>在dropFirst，prefix， drop(while:) 方法中，返回的并非为Array或者Sequence类型，而是返回了对应的XXSequence struct 类型。看注释上说时可以lazily consume. 这几类Sequence有些类似Box/Wrapper Sequence.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A sequence that lazily consumes and drops `n` elements from an underlying</span></span><br><span class="line"><span class="comment">/// `Base` iterator before possibly returning the first available element.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The underlying iterator's sequence may be infinite.</span></span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">DropFirstSequence</span>&lt;<span class="title">Base</span>: <span class="title">Sequence</span>&gt; </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> _base: <span class="type">Base</span></span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> _limit: <span class="type">Int</span></span><br><span class="line">  </span><br><span class="line">  @inlinable </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>, dropping limit: <span class="type">Int</span>) &#123;</span><br><span class="line">    _precondition(limit &gt;= <span class="number">0</span>, </span><br><span class="line">      <span class="string">"Can't drop a negative number of elements from a sequence"</span>)</span><br><span class="line">    _base = base</span><br><span class="line">    _limit = limit</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DropFirstSequence</span>: <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Element</span> = <span class="type">Base</span>.<span class="type">Element</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Iterator</span> = <span class="type">Base</span>.<span class="type">Iterator</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">SubSequence</span> = <span class="type">AnySequence</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line">  </span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> it = _base.makeIterator()</span><br><span class="line">    <span class="keyword">var</span> dropped = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> dropped &lt; _limit, it.next() != <span class="literal">nil</span> &#123; dropped &amp;+= <span class="number">1</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> it</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">dropFirst</span><span class="params">(<span class="number">_</span> k: Int)</span></span> -&gt; <span class="type">DropFirstSequence</span>&lt;<span class="type">Base</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// If this is already a _DropFirstSequence, we need to fold in</span></span><br><span class="line">    <span class="comment">// the current drop count and drop limit so no data is lost.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// i.e. [1,2,3,4].dropFirst(1).dropFirst(1) should be equivalent to</span></span><br><span class="line">    <span class="comment">// [1,2,3,4].dropFirst(2).</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">DropFirstSequence</span>(_base, dropping: _limit + k)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A sequence that only consumes up to `n` elements from an underlying</span></span><br><span class="line"><span class="comment">/// `Base` iterator.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The underlying iterator's sequence may be infinite.</span></span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">PrefixSequence</span>&lt;<span class="title">Base</span>: <span class="title">Sequence</span>&gt; </span>&#123;</span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _base: <span class="type">Base</span></span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> _maxLength: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>, maxLength: <span class="type">Int</span>) &#123;</span><br><span class="line">    _precondition(maxLength &gt;= <span class="number">0</span>, <span class="string">"Can't take a prefix of negative length"</span>)</span><br><span class="line">    _base = base</span><br><span class="line">    _maxLength = maxLength</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A sequence that lazily consumes and drops `n` elements from an underlying</span></span><br><span class="line"><span class="comment">/// `Base` iterator before possibly returning the first available element.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The underlying iterator's sequence may be infinite.</span></span><br><span class="line">@frozen</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">DropWhileSequence</span>&lt;<span class="title">Base</span>: <span class="title">Sequence</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Element</span> = <span class="type">Base</span>.<span class="type">Element</span></span><br><span class="line">  </span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _iterator: <span class="type">Base</span>.<span class="type">Iterator</span></span><br><span class="line">  @usableFromInline</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> _nextElement: <span class="type">Element</span>?</span><br><span class="line">  </span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(iterator: <span class="type">Base</span>.<span class="type">Iterator</span>, predicate: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">Bool</span>) <span class="keyword">rethrows</span> &#123;</span><br><span class="line">    _iterator = iterator</span><br><span class="line">    _nextElement = _iterator.next()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> x = _nextElement, <span class="keyword">try</span> predicate(x) &#123;</span><br><span class="line">      _nextElement = _iterator.next()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>, predicate: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">Bool</span>) <span class="keyword">rethrows</span> &#123;</span><br><span class="line">    <span class="keyword">self</span> = <span class="keyword">try</span> <span class="type">DropWhileSequence</span>(iterator: base.makeIterator(), predicate: predicate)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Functions">Functions</h1><h2 id="suffix(__maxLength:_Int)">suffix(_ maxLength: Int)</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Returns a subsequence, up to the given maximum length, containing the</span></span><br><span class="line"><span class="comment">/// final elements of the sequence.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The sequence must be finite. If the maximum length exceeds the number of</span></span><br><span class="line"><span class="comment">/// elements in the sequence, the result contains all the elements in the</span></span><br><span class="line"><span class="comment">/// sequence.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let numbers = [1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="comment">///     print(numbers.suffix(2))</span></span><br><span class="line"><span class="comment">///     // Prints "[4, 5]"</span></span><br><span class="line"><span class="comment">///     print(numbers.suffix(10))</span></span><br><span class="line"><span class="comment">///     // Prints "[1, 2, 3, 4, 5]"</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter maxLength: The maximum number of elements to return. The</span></span><br><span class="line"><span class="comment">///   value of `maxLength` must be greater than or equal to zero.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(*n*), where *n* is the length of the sequence.</span></span><br><span class="line">@inlinable</span><br><span class="line"><span class="keyword">public</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">suffix</span><span class="params">(<span class="number">_</span> maxLength: Int)</span></span> -&gt; [<span class="type">Element</span>] &#123;</span><br><span class="line">  _Precondition(maxLength &gt;= <span class="number">0</span>, <span class="string">"Can't take a suffix of negative length from a sequence"</span>)</span><br><span class="line">  <span class="keyword">guard</span> maxLength != <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> &lt;rdar://problem/21885650&gt; Create reusable RingBuffer&lt;T&gt;</span></span><br><span class="line">  <span class="comment">// Put incoming elements into a ring buffer to save space. Once all</span></span><br><span class="line">  <span class="comment">// elements are consumed, reorder the ring buffer into a copy and return it.</span></span><br><span class="line">  <span class="comment">// This saves memory for sequences particularly longer than `maxLength`.</span></span><br><span class="line">  <span class="comment">// 这里提到[RingBuffer](https://en.wikipedia.org/wiki/Circular_buffer)这个数据结构用于节省空间，这块还是值得注意的。因为如果使用正常的Array或者ContiguousArray，会创建一个和self本身同等大小的array，而使用RingBuffer则只会使用maxLength大小的空间.</span></span><br><span class="line">  <span class="comment">// 已经有相关RingBuffer(CircularBuffer)实现的[PR](https://github.com/apple/swift/pull/30242/files)，最终没有merge到main</span></span><br><span class="line">  <span class="keyword">var</span> ringBuffer = <span class="type">ContiguousArray</span>&lt;<span class="type">Element</span>&gt;()</span><br><span class="line">  ringBuffer.reserveCapacity(<span class="type">Swift</span>.<span class="built_in">min</span>(maxLength, underestimatedCount))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> element <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ringBuffer.<span class="built_in">count</span> &lt; maxLength &#123;</span><br><span class="line">      ringBuffer.append(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// RingBuffer相关操作，只保留buffer大小的数据，其他数据进行覆盖</span></span><br><span class="line">      ringBuffer[i] = element</span><br><span class="line">      i = (i + <span class="number">1</span>) % maxLength</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> i != ringBuffer.startIndex &#123;</span><br><span class="line">    <span class="comment">// Rotate RingBuffer</span></span><br><span class="line">    <span class="keyword">var</span> rotated = <span class="type">ContiguousArray</span>&lt;<span class="type">Element</span>&gt;()</span><br><span class="line">    rotated.reserveCapacity(ringBuffer.<span class="built_in">count</span>)</span><br><span class="line">    rotated += ringBuffer[i..&lt;ringBuffer.endIndex]</span><br><span class="line">    rotated += ringBuffer[<span class="number">0</span>..&lt;i]</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Array</span>(rotated)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Array</span>(ringBuffer)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dropLast(__k:_Int_=_1)_-&gt;_[Element]">dropLast(_ k: Int = 1) -&gt; [Element]</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Returns a sequence containing all but the given number of final</span></span><br><span class="line"><span class="comment">/// elements.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The sequence must be finite. If the number of elements to drop exceeds</span></span><br><span class="line"><span class="comment">/// the number of elements in the sequence, the result is an empty</span></span><br><span class="line"><span class="comment">/// sequence.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let numbers = [1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="comment">///     print(numbers.dropLast(2))</span></span><br><span class="line"><span class="comment">///     // Prints "[1, 2, 3]"</span></span><br><span class="line"><span class="comment">///     print(numbers.dropLast(10))</span></span><br><span class="line"><span class="comment">///     // Prints "[]"</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter n: The number of elements to drop off the end of the</span></span><br><span class="line"><span class="comment">///   sequence. `n` must be greater than or equal to zero.</span></span><br><span class="line"><span class="comment">/// - Returns: A sequence leaving off the specified number of elements.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(*n*), where *n* is the length of the sequence.</span></span><br><span class="line">@inlinable</span><br><span class="line"><span class="keyword">public</span> __consuming <span class="func"><span class="keyword">func</span> <span class="title">dropLast</span><span class="params">(<span class="number">_</span> k: Int = <span class="number">1</span>)</span></span> -&gt; [<span class="type">Element</span>] &#123;</span><br><span class="line">  _precondition(k &gt;= <span class="number">0</span>, <span class="string">"Can't drop a negative number of elements from a sequence"</span>)</span><br><span class="line">  <span class="keyword">guard</span> k != <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="type">Array</span>(<span class="keyword">self</span>) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> &lt;rdar://problem/21885650&gt; Create reusable RingBuffer&lt;T&gt;</span></span><br><span class="line">  <span class="comment">// Put incoming elements from this sequence in a holding tank, a ring buffer</span></span><br><span class="line">  <span class="comment">// of size &lt;= k. If more elements keep coming in, pull them out of the</span></span><br><span class="line">  <span class="comment">// holding tank into the result, an `Array`. This saves</span></span><br><span class="line">  <span class="comment">// `k` * sizeof(Element) of memory, because slices keep the entire</span></span><br><span class="line">  <span class="comment">// memory of an `Array` alive.</span></span><br><span class="line">  <span class="keyword">var</span> result = <span class="type">ContiguousArray</span>&lt;<span class="type">Element</span>&gt;()</span><br><span class="line">  <span class="comment">// ringBuffer的大小同k相同，最后会保存被drop的元素</span></span><br><span class="line">  <span class="keyword">var</span> ringBuffer = <span class="type">ContiguousArray</span>&lt;<span class="type">Element</span>&gt;()</span><br><span class="line">  <span class="keyword">var</span> i = ringBuffer.startIndex</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> element <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">    <span class="comment">// 当ringbuffer小于k时，将元素放入ringbuffer中(holding tank)</span></span><br><span class="line">    <span class="keyword">if</span> ringBuffer.<span class="built_in">count</span> &lt; k &#123;</span><br><span class="line">      ringBuffer.append(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// pull them out of the holding tank into the result</span></span><br><span class="line">      result.append(ringBuffer[i])</span><br><span class="line">      <span class="comment">// 更新ringbuffer与index</span></span><br><span class="line">      ringBuffer[i] = element</span><br><span class="line">      i = (i + <span class="number">1</span>) % k</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Array</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="elementsEqual">elementsEqual</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Sequence</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// 直接比较两个两个类型的Sequence元素是否相同，可以省去转换成相同type的步骤</span></span><br><span class="line">  <span class="comment">/// Returns a Boolean value indicating whether this sequence and another</span></span><br><span class="line">  <span class="comment">/// sequence contain the same elements in the same order.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// At least one of the sequences must be finite.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// This example tests whether one countable range shares the same elements</span></span><br><span class="line">  <span class="comment">/// as another countable range and an array.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let a = 1...3</span></span><br><span class="line">  <span class="comment">///     let b = 1...10</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     print(a.elementsEqual(b))</span></span><br><span class="line">  <span class="comment">///     // Prints "false"</span></span><br><span class="line">  <span class="comment">///     print(a.elementsEqual([1, 2, 3]))</span></span><br><span class="line">  <span class="comment">///     // Prints "true"</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter other: A sequence to compare to this sequence.</span></span><br><span class="line">  <span class="comment">/// - Returns: `true` if this sequence and `other` contain the same elements</span></span><br><span class="line">  <span class="comment">///   in the same order.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(*m*), where *m* is the lesser of the length of the</span></span><br><span class="line">  <span class="comment">///   sequence and the length of `other`.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">elementsEqual</span><span class="generics">&lt;OtherSequence: Sequence&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> other: OtherSequence</span><br><span class="line">  )</span></span> -&gt; <span class="type">Bool</span> <span class="keyword">where</span> <span class="type">OtherSequence</span>.<span class="type">Element</span> == <span class="type">Element</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.elementsEqual(other, by: ==)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="flatMap">flatMap</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Returns an array containing the concatenated results of calling the</span></span><br><span class="line">  <span class="comment">/// given transformation with each element of this sequence.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Use this method to receive a single-level collection when your</span></span><br><span class="line">  <span class="comment">/// transformation produces a sequence or collection for each element.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// In this example, note the difference in the result of using `map` and</span></span><br><span class="line">  <span class="comment">/// `flatMap` with a transformation that returns an array.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let numbers = [1, 2, 3, 4]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let mapped = numbers.map &#123; Array(repeating: $0, count: $0) &#125;</span></span><br><span class="line">  <span class="comment">///     // [[1], [2, 2], [3, 3, 3], [4, 4, 4, 4]]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let flatMapped = numbers.flatMap &#123; Array(repeating: $0, count: $0) &#125;</span></span><br><span class="line">  <span class="comment">///     // [1, 2, 2, 3, 3, 3, 4, 4, 4, 4]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// In fact, `s.flatMap(transform)`  is equivalent to</span></span><br><span class="line">  <span class="comment">/// `Array(s.map(transform).joined())`.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter transform: A closure that accepts an element of this</span></span><br><span class="line">  <span class="comment">///   sequence as its argument and returns a sequence or collection.</span></span><br><span class="line">  <span class="comment">/// - Returns: The resulting flattened array.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(*m* + *n*), where *n* is the length of this sequence</span></span><br><span class="line">  <span class="comment">///   and *m* is the length of the result.</span></span><br><span class="line">  @inlinable</span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">flatMap</span><span class="generics">&lt;SegmentOfResult: Sequence&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> transform: <span class="params">(Element)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">SegmentOfResult</span></span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; [<span class="type">SegmentOfResult</span>.<span class="type">Element</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> result: [<span class="type">SegmentOfResult</span>.<span class="type">Element</span>] = []</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">      <span class="comment">/// 有别于map的地方</span></span><br><span class="line">      result.append(contentsOf: <span class="keyword">try</span> transform(element))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="compactMap">compactMap</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Returns an array containing the non-`nil` results of calling the given</span></span><br><span class="line">  <span class="comment">/// transformation with each element of this sequence.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// Use this method to receive an array of non-optional values when your</span></span><br><span class="line">  <span class="comment">/// transformation produces an optional value.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// In this example, note the difference in the result of using `map` and</span></span><br><span class="line">  <span class="comment">/// `compactMap` with a transformation that returns an optional `Int` value.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let possibleNumbers = ["1", "2", "three", "///4///", "5"]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let mapped: [Int?] = possibleNumbers.map &#123; str in Int(str) &#125;</span></span><br><span class="line">  <span class="comment">///     // [1, 2, nil, nil, 5]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">///     let compactMapped: [Int] = possibleNumbers.compactMap &#123; str in Int(str) &#125;</span></span><br><span class="line">  <span class="comment">///     // [1, 2, 5]</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Parameter transform: A closure that accepts an element of this</span></span><br><span class="line">  <span class="comment">///   sequence as its argument and returns an optional value.</span></span><br><span class="line">  <span class="comment">/// - Returns: An array of the non-`nil` results of calling `transform`</span></span><br><span class="line">  <span class="comment">///   with each element of the sequence.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// - Complexity: O(*m* + *n*), where *n* is the length of this sequence</span></span><br><span class="line">  <span class="comment">///   and *m* is the length of the result.</span></span><br><span class="line">  @inlinable <span class="comment">// protocol-only</span></span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">compactMap</span><span class="generics">&lt;ElementOfResult&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> transform: <span class="params">(Element)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">ElementOfResult</span>?</span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; [<span class="type">ElementOfResult</span>] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> _compactMap(transform)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The implementation of compactMap accepting a closure with an optional result.</span></span><br><span class="line">  <span class="comment">// Factored out into a separate function in order to be used in multiple</span></span><br><span class="line">  <span class="comment">// overloads.</span></span><br><span class="line">  @inlinable <span class="comment">// protocol-only</span></span><br><span class="line">  @inline(__always)</span><br><span class="line">  <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">_compactMap</span><span class="generics">&lt;ElementOfResult&gt;</span><span class="params">(</span><br><span class="line">    <span class="number">_</span> transform: <span class="params">(Element)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">ElementOfResult</span>?</span><br><span class="line">  ) <span class="keyword">rethrows</span> -&gt; [<span class="type">ElementOfResult</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> result: [<span class="type">ElementOfResult</span>] = []</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">      <span class="comment">/// 与map的区别</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> newElement = <span class="keyword">try</span> transform(element) &#123;</span><br><span class="line">        result.append(newElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/05/04/Swift-Source-Code-Sequence/" data-id="cl8wql7ez001x03xkgdg66h2d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swift-source-code/">swift source code</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Reading-Note-of-Book-Deep-Work" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/29/Reading-Note-of-Book-Deep-Work/" class="article-date">
  <time datetime="2021-03-29T12:11:26.000Z" itemprop="datePublished">2021-03-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/29/Reading-Note-of-Book-Deep-Work/">Reading Note of Book: Deep Work</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Chapter_One_-_Deep_work_is_valuable:">Chapter One - Deep work is valuable:</h2><h3 id="Two_Core_Abilities_for_Thriving_in_the_New_Economy">Two Core Abilities for Thriving in the New Economy</h3><ol>
<li>The ability to quickly master hard things.</li>
<li>The ability to produce at an elite level, in terms of both quality and speed.</li>
</ol>
<h3 id="Deep_Work_Helps_You_Quickly_Learn_Hard_Things">Deep Work Helps You Quickly Learn Hard Things</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Let your mind become a lens, thanks to the converging rays of attention;&#10;let your soul be all intent on whatever it is that is established in your mind as a dominant, wholly absorbing idea.&#10;-- Antonin-Dalmace Sertillanges</span><br></pre></td></tr></table></figure>
<h4 id="Deliberate_practice">Deliberate practice</h4><ul>
<li>your attention is focused tightly on a specific skill you’re trying to improve or an idea you’re trying to master;</li>
<li>you receive feedback so you can correct your approach to keep your attention exactly where it’s most productive.</li>
</ul>
<h3 id="Deep_Work_Helps_You_Produce_at_an_Elite_Level">Deep Work Helps You Produce at an Elite Level</h3><p><code>High-Quality Work Produced = (Time Spent) x (Intensity of Focus)</code></p>
<h2 id="Chapter_Two_-_Deep_work_is_rare:">Chapter Two - Deep work is rare:</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">To do real good physics work, you do need absolute solid lengths&#10;of time...it needs a lot of concentration...if you have a job&#10;administrating anything, you don&#39;t have the time. So, I have&#10;invented another myth for myself: that I&#39;m irresponsible.&#10;I&#39;m actively irresponsible. I tell everyone I don&#39;t do anything.&#10;If anyone asks me to be on a committee for admissions, &#34;no,&#34; I tell&#10;them:I&#39;m irresponsible. -- Feynman</span><br></pre></td></tr></table></figure>
<h3 id="Busyness_as_Proxy_for_Productivity">Busyness as Proxy for Productivity</h3><p>In the absence of clear indicators of what it means to be productive and<br>valuable in their jobs, many knowledge workers turn back toward an industrial<br>indicator of productivity: doing lots of stuff in a visible manner.</p>
<p>Deep work is at a servere disadvantage in a technopoly because it builds on values like<br>quality, craftsmanship, and mastery that are decidedly old-fashioned and nontechnological.<br>Even worse, to support deep work often requires the rejection of much of what is new and high-tech.<br>Deep work is exiled in favor of more distracting high-tech behaviors.</p>
<h2 id="Chapter_Three_-_Deep_Work_Is_Meaningful">Chapter Three - Deep Work Is Meaningful</h2><h3 id="A_Neurological_Argument_for_Depth">A Neurological Argument for Depth</h3><p>Your world is the outcome of what you pay attention to, so consider for a moment the type of mental world constructed when you dedicate significant time to deep endeavors. There’s gravity and snese of imprortance inherent in deep work.</p>
<p>The idle mind is the devil’s workshop. When you lose focus, your mind tends to fix on what could be wrong with your life instead of what’s right.</p>
<p>A workday driven by the shallow, from a neurological perspective, is likely to be a draining and upsetting day, even if most of the shallow things that capture your attention seem harmless or fun.</p>
<h3 id="A_Pssychological_Argument_for_Depth">A Pssychological Argument for Depth</h3><p>Ironically, jobs are actually easier to enjoy than free time, because like flow activities they have built-in goals, feedback rules, and challenges, all of which encourage one to become involved in one’s work, to concentrate and lose oneself in it. Free time, on the other hand, is unstructured, and requires much greater effort to be shaped into something that can be enjoyed.</p>
<h3 id="A_Philosophical_Argument_for_Depth">A Philosophical Argument for Depth</h3><p>Beautiful code is short and concise, so if you were to give that code to another programmer they would say, “oh, that’s well written code.” It’s much like as if you were writing a poem.</p>
<p>Within the overall structure of a project there is always room for individuality and craftsmanship…One hundred years from now, our engineering may seem as archaic as the techniques used by medieval cathedral builders seem to today’s civil engineers, while our craftsmanship will still be honored.</p>
<h2 id="Chapter_Four_-_Rule_1:_Work_Deeply">Chapter Four - Rule 1: Work Deeply</h2><p>You have a finite amount of willpower that becomes depleted as you use it.</p>
<p>The key to developing a deep work habit is to move beyond good intentions and add <strong>routines</strong> and <strong>rituals</strong> to your working life designed to minimize the amount of your limited willpower necessary to transition into and maintain a state of unbroken concentration.</p>
<p><strong>warning</strong>: You must be careful to choose a philosophy that fits your specific circumstances.</p>
<h3 id="The_monastic_Philosophy_of_Deep_Work_Scheduling">The monastic Philosophy of Deep Work Scheduling</h3><p>This philosophy attempts to maximize deep efforts by eliminating or radically minimizing shallow obligations.</p>
<h3 id="The_Bimodal_Philosophy_of_Deep_Work_Scheduling">The Bimodal Philosophy of Deep Work Scheduling</h3><p>This philosophy asks that you divide your time, dedicating some clearly defined staretches to deep pursuits and leaving the rest open to everything else.</p>
<h3 id="The_Rhythmic_Philosophy_of_Deep_Work_Scheduling">The Rhythmic Philosophy of Deep Work Scheduling</h3><p>This philosophy argues that the easiest way to consistently start deep work sessions is to transform them into a simple regular habit. The goal, in other words, is to generate a rhythm for this work that removes the need for you to invest energy in deciding if and when you’re going to go deep. The chain method is a good example of the rhythmic philosophy of deep work scheduling because it combines a simple scheduling euristic, with an easy way to remind yourself to do the work: the big red Xs on the calendar.</p>
<h3 id="The_Jourualistic_Philosophy_of_Deep_Work_Scheduling">The Jourualistic Philosophy of Deep Work Scheduling</h3><p>I call this approach, in which you fit deep work wherever you can into your schedule, the journalist philosophy.<br>This approach is not for the deep work novice. As I established in the opening to this rule, the ability to rapidly switch your mind from shallow to deep mode doesn’t come naturally. Without practice, such switches can seriously deplete your finite willpower reserves. This habit also requires a sense of confidence in your abilities.</p>
<h3 id="Deep_work_ritual">Deep work ritual</h3><ul>
<li><p>Where you’ll work and for how long. Your ritual needs to specify a location for your deep work efforts.</p>
</li>
<li><p>How you’ll work once you start to work. Your ritual needs rules and processes to keep your efforts structured.</p>
</li>
<li><p>How you’ll support you work. Your ritual needs to ensure your brain gets the support it needs to keep operating at a high level of depth.</p>
</li>
</ul>
<h3 id="Make_Grand_Gestures">Make Grand Gestures</h3><p>The concept is simple: By leveraging a radical change to your normal environment, coupled perhaps with a significant investment of effort or money, all dedicated toward supporting a deep work task, you increase the perceived importance of the task. This boost in importance reduces your mind’s instinct to procrastinate and delivers an injection of motivation and energy.</p>
<h3 id="The_4_disciplines_of_excution">The 4 disciplines of excution</h3><ul>
<li>Discipline 1: Focus on the wildly important</li>
</ul>
<p>“The more you try to do, the less you actually accomplish.” execution should be aimed at a small number of “wildly important goals.” This simplicity will help focus an organization’s energy to a sufficient intensity to ignite real results.</p>
<p>For an individual focused on deep work, the implication is that you should identify a small number of ambitious outcomes to pursue with your deep work hours.</p>
<ul>
<li>Discipline 2: Act on the lead measures</li>
</ul>
<p>once you’ve identified a wildly important goal, you need to measure your success.</p>
<p>For an individual focused on deep work, it’s easy to identify the relevant lead measure: time spent in a state of deep work dedicated toward your wildly important goal.</p>
<ul>
<li><p>Discipline 3: Keep a compilling scoreboard.</p>
</li>
<li><p>Discipline 4: Create a cadence of accountability.</p>
</li>
</ul>
<h4 id="Why_a_shutdown_will_be_proftable_to_your_ability_to_produce_valuable_output-">Why a shutdown will be proftable to your ability to produce valuable output.</h4><ul>
<li><p>Reason 1: Downtime aids insights.</p>
</li>
<li><p>Reason 2: Downtime helps recharge the energy needed to work deeply.</p>
</li>
<li><p>Reason 3: The work that evening downtime replaces is usually not that important.</p>
</li>
</ul>
<h2 id="Rule_2:_Embrace_boredom">Rule 2: Embrace boredom</h2><ul>
<li><p>Rule 1: taught you how to integrate deep work into your schedule and support it with routines and rituals designed to help you consistently reach the current limiit of your concentration ability.</p>
</li>
<li><p>Rule 2: will help you significantly improve this limit. The starategies that follow are motivated by the key idea that getting the most out of your deep work habit requires training, and as clarified previously, this training must address two goals:</p>
<ul>
<li>improving your ability to concentrate intensely and</li>
<li>overcoming your desire for distraction</li>
</ul>
</li>
</ul>
<ul>
<li>Don’t take breaks from distraction, instead take breaks from focus.<br>point 1: this strategy works even if your job requires lots of internet use and/or prompt e-mail replies.<br>point 2: regardless of how you schedule your internet blocks, you must keep the time outside those blocks absolutely free from internet use.<br>point 3: scheduling internet use at home as well as at work can further improve your concentration traning.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/29/Reading-Note-of-Book-Deep-Work/" data-id="cl8wql7fp002703xkui2elmvi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书/">读书</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLite/">SQLite</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unix/">Unix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/combine/">combine</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/">life</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-archlinux/">linux, archlinux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phonegap/">phonegap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading/">reading</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift-source-code/">swift source code</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编辑器配置文件/">编辑器配置文件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 17.5px;">C</a> <a href="/tags/SQLite/" style="font-size: 10px;">SQLite</a> <a href="/tags/Swift/" style="font-size: 10px;">Swift</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/combine/" style="font-size: 12.5px;">combine</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/linux-archlinux/" style="font-size: 10px;">linux, archlinux</a> <a href="/tags/phonegap/" style="font-size: 10px;">phonegap</a> <a href="/tags/programming/" style="font-size: 10px;">programming</a> <a href="/tags/reading/" style="font-size: 17.5px;">reading</a> <a href="/tags/swift-source-code/" style="font-size: 15px;">swift source code</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/编辑器配置文件/" style="font-size: 10px;">编辑器配置文件</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">十月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/06/Four-Thousand-Weeks/">Four Thousand Weeks</a>
          </li>
        
          <li>
            <a href="/2022/07/06/麦肯锡方法/">麦肯锡方法</a>
          </li>
        
          <li>
            <a href="/2022/06/19/悉达多/">悉达多</a>
          </li>
        
          <li>
            <a href="/2022/06/13/信心/">信心</a>
          </li>
        
          <li>
            <a href="/2022/06/04/Combine-Publisher/">Combine: Publisher</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Anyuan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">home</a>
  
    <a href="/archives" class="mobile-nav-link">archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>